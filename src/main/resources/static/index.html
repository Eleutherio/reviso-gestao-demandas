<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviso | Admin Console</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f7fb;
        overflow-x: hidden;
      }
      .status-badge {
        text-transform: uppercase;
        font-size: 0.75rem;
      }
      .card-shadow {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid #eef1f5;
      }
      .clickable {
        cursor: pointer;
      }
      .list-scroll {
        max-height: calc(100vh - 280px);
        overflow-y: auto;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #f2f4f7 25%,
          #e9ecf2 37%,
          #f2f4f7 63%
        );
        background-size: 400% 100%;
        animation: shimmer 1.4s ease infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 100% 0;
        }
        100% {
          background-position: -100% 0;
        }
      }
      #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 100vw;
        pointer-events: none;
      }
      #toastContainer .toast {
        pointer-events: auto;
        margin-bottom: 10px;
        min-width: 250px;
        max-width: calc(100vw - 40px);
      }
      @media (max-width: 992px) {
        .list-scroll {
          max-height: 50vh;
        }
        #toastContainer {
          top: 10px;
          right: 10px;
        }
        #toastContainer .toast {
          min-width: 200px;
          max-width: calc(100vw - 20px);
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark mb-3">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Reviso - Admin Console</span>
      </div>
    </nav>

    <div class="container-fluid">
      <ul class="nav nav-pills mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="tab-cliente"
            data-bs-toggle="pill"
            data-bs-target="#pane-clientes"
            type="button"
            role="tab"
          >
            Clientes
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-cadastrar"
            data-bs-toggle="pill"
            data-bs-target="#pane-cadastrar"
            type="button"
            role="tab"
          >
            Cadastrar Requisição de Cliente
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-consultar"
            data-bs-toggle="pill"
            data-bs-target="#pane-consultar"
            type="button"
            role="tab"
          >
            Consultar Requisições
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-workflow"
            data-bs-toggle="pill"
            data-bs-target="#pane-workflow"
            type="button"
            role="tab"
          >
            Workflow
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-eventos"
            data-bs-toggle="pill"
            data-bs-target="#pane-eventos"
            type="button"
            role="tab"
          >
            Eventos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-relatorios"
            data-bs-toggle="pill"
            data-bs-target="#pane-relatorios"
            type="button"
            role="tab"
          >
            Relatórios
          </button>
        </li>
      </ul>

      <div class="tab-content" id="tabContent">
        <div
          class="tab-pane fade show active"
          id="pane-clientes"
          role="tabpanel"
        >
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-shadow">
                <div class="card-body">
                  <h5 class="card-title">Criar cliente</h5>
                  <div class="mb-3">
                    <label class="form-label">Nome *</label>
                    <input
                      class="form-control"
                      id="clientName"
                      placeholder="Ex: Agência Orion"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Segmento</label>
                    <input
                      class="form-control"
                      id="clientSegment"
                      placeholder="Ex: Publicidade"
                    />
                  </div>
                  <button
                    class="btn btn-success w-100"
                    onclick="createClient()"
                  >
                    Criar
                  </button>
                </div>
              </div>
            </div>
            <div class="col-lg-8">
              <div class="card card-shadow">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <h5 class="card-title mb-0">Clientes</h5>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      onclick="listClients()"
                    >
                      Recarregar
                    </button>
                  </div>
                  <div
                    class="table-responsive list-scroll"
                    id="clientList"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-cadastrar" role="tabpanel">
          <div class="row g-3">
            <div class="col-lg-5 col-xl-4">
              <div class="card card-shadow">
                <div class="card-body">
                  <h5 class="card-title">Cadastrar requisição de cliente</h5>
                  <p class="text-muted small">
                    Preencha os campos para abrir uma nova requisição.
                  </p>
                  <div class="mb-2">
                    <label class="form-label">ID do cliente *</label
                    ><input
                      class="form-control"
                      id="requestClientId"
                      placeholder="UUID do cliente"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Título *</label
                    ><input
                      class="form-control"
                      id="requestTitle"
                      placeholder="Ex: Novo banner"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Descrição</label
                    ><textarea
                      class="form-control"
                      id="requestDescription"
                      rows="2"
                      placeholder="Contexto e links"
                    ></textarea>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label
                    ><select class="form-select" id="requestType">
                      <option value="">Selecione...</option>
                      <option value="POST">Post</option>
                      <option value="STORY">Story</option>
                      <option value="BANNER">Banner</option>
                      <option value="LANDING_PAGE">Landing page</option>
                      <option value="TRAFFIC">Tráfego</option>
                      <option value="EMAIL">E-mail</option>
                      <option value="VIDEO">Vídeo</option>
                      <option value="OTHER">Outro</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Prioridade</label
                    ><select class="form-select" id="requestPriority">
                      <option value="">Selecione...</option>
                      <option value="LOW">Baixa</option>
                      <option value="MEDIUM">Média</option>
                      <option value="HIGH">Alta</option>
                      <option value="URGENT">Urgente</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Vencimento</label
                    ><input
                      type="datetime-local"
                      class="form-control"
                      id="requestDueDate"
                    />
                  </div>
                  <button
                    class="btn btn-success w-100"
                    onclick="createRequest()"
                  >
                    Criar requisição
                  </button>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-xl-8">
              <div class="card card-shadow h-100">
                <div
                  class="card-body d-flex align-items-center justify-content-center text-muted"
                >
                  <div class="text-center">
                    <h6 class="mb-2">Dica</h6>
                    <p class="mb-0">
                      Após criar, use a aba "Consultar Requisições" para
                      acompanhar, editar e mover no workflow.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-consultar" role="tabpanel">
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card card-shadow">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <h6 class="mb-0">Filtros</h6>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      onclick="clearFilters()"
                    >
                      Limpar
                    </button>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Cliente</label
                    ><input
                      class="form-control"
                      id="filterClientId"
                      placeholder="UUID"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Status</label
                    ><select class="form-select" id="filterStatus">
                      <option value="">Todos</option>
                      <option value="NEW">Novo</option>
                      <option value="IN_PROGRESS">Em progresso</option>
                      <option value="IN_REVIEW">Em revisão</option>
                      <option value="CHANGES_REQUESTED">
                        Mudanças solicitadas
                      </option>
                      <option value="APPROVED">Aprovado</option>
                      <option value="DELIVERED">Entregue</option>
                      <option value="CLOSED">Encerrado</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Prioridade</label
                    ><select class="form-select" id="filterPriority">
                      <option value="">Todas</option>
                      <option value="LOW">Baixa</option>
                      <option value="MEDIUM">Média</option>
                      <option value="HIGH">Alta</option>
                      <option value="URGENT">Urgente</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Tipo</label
                    ><select class="form-select" id="filterType">
                      <option value="">Todos</option>
                      <option value="POST">Post</option>
                      <option value="STORY">Story</option>
                      <option value="BANNER">Banner</option>
                      <option value="LANDING_PAGE">Landing page</option>
                      <option value="TRAFFIC">Tráfego</option>
                      <option value="EMAIL">E-mail</option>
                      <option value="VIDEO">Vídeo</option>
                      <option value="OTHER">Outro</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Criado de</label
                    ><input
                      type="datetime-local"
                      class="form-control"
                      id="filterCreatedFrom"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Criado até</label
                    ><input
                      type="datetime-local"
                      class="form-control"
                      id="filterCreatedTo"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Vencimento até</label
                    ><input
                      type="datetime-local"
                      class="form-control"
                      id="filterDueBefore"
                    />
                  </div>
                  <div class="row g-2 mb-2">
                    <div class="col">
                      <label class="form-label">Página</label
                      ><input
                        type="number"
                        class="form-control"
                        id="filterPage"
                        value="0"
                        min="0"
                      />
                    </div>
                    <div class="col">
                      <label class="form-label">Tamanho</label
                      ><input
                        type="number"
                        class="form-control"
                        id="filterSize"
                        value="20"
                        min="1"
                        max="100"
                      />
                    </div>
                  </div>
                  <div class="row g-2 mb-3">
                    <div class="col">
                      <label class="form-label">Ordenar por</label
                      ><select class="form-select" id="filterSortBy">
                        <option value="createdAt">Criado em</option>
                        <option value="dueDate">Vencimento</option>
                        <option value="title">Título</option>
                        <option value="priority">Prioridade</option>
                      </select>
                    </div>
                    <div class="col">
                      <label class="form-label">Direção</label
                      ><select class="form-select" id="filterDirection">
                        <option value="desc">Desc</option>
                        <option value="asc">Asc</option>
                      </select>
                    </div>
                  </div>
                  <button
                    class="btn btn-primary w-100"
                    onclick="advancedSearch()"
                  >
                    Buscar
                  </button>
                </div>
              </div>
            </div>

            <div class="col-lg-8">
              <div class="card card-shadow mb-3">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <h5 class="mb-0">Requisições</h5>
                    <div>
                      <span class="text-muted small" id="reqSummary"></span>
                    </div>
                  </div>
                  <div id="requestList" class="list-group list-scroll"></div>
                </div>
              </div>

              <div
                class="card card-shadow"
                id="detailCard"
                style="display: none"
              >
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-start mb-2"
                  >
                    <div>
                      <h5 id="detailTitle" class="mb-1"></h5>
                      <div class="text-muted small" id="detailId"></div>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button
                        class="btn btn-outline-secondary"
                        onclick="copySelectedId()"
                      >
                        Copiar ID
                      </button>
                      <button
                        class="btn btn-outline-primary"
                        onclick="openWorkflowTab()"
                      >
                        Abrir no Workflow
                      </button>
                    </div>
                  </div>
                  <div class="mb-2" id="detailBadges"></div>
                  <p class="text-secondary" id="detailDescription"></p>
                  <div class="row g-2 mb-3">
                    <div class="col-md-4">
                      <small class="text-muted">Cliente</small>
                      <div id="detailClient"></div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted">Vencimento</small>
                      <div id="detailDue"></div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted">Revisões</small>
                      <div id="detailRevision"></div>
                    </div>
                  </div>
                  <div class="row g-2 mb-4">
                    <div class="col-md-6">
                      <small class="text-muted">Responsável</small>
                      <div id="detailAssignee"></div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Criado/Atualizado</small>
                      <div id="detailDates"></div>
                    </div>
                  </div>

                  <div class="row g-3">
                    <div class="col-lg-6">
                      <h6>Alterar status</h6>
                      <div class="mb-2">
                        <label class="form-label">Novo status</label
                        ><select class="form-select" id="wfStatus">
                          <option value="">Selecione</option>
                          <option value="NEW">Novo</option>
                          <option value="IN_PROGRESS">Em progresso</option>
                          <option value="IN_REVIEW">Em revisão</option>
                          <option value="CHANGES_REQUESTED">
                            Mudanças solicitadas
                          </option>
                          <option value="APPROVED">Aprovado</option>
                          <option value="DELIVERED">Entregue</option>
                          <option value="CLOSED">Encerrado</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Mensagem</label
                        ><input
                          class="form-control"
                          id="wfStatusMsg"
                          placeholder="Contexto"
                        />
                      </div>
                      <button
                        class="btn btn-primary w-100"
                        onclick="changeStatusAction()"
                      >
                        Salvar
                      </button>
                    </div>
                    <div class="col-lg-6">
                      <h6>Comentário</h6>
                      <div class="mb-2">
                        <textarea
                          class="form-control"
                          id="wfComment"
                          rows="3"
                          placeholder="Mensagem"
                        ></textarea>
                      </div>
                      <button
                        class="btn btn-outline-primary w-100"
                        onclick="addCommentAction()"
                      >
                        Adicionar comentário
                      </button>
                    </div>
                    <div class="col-lg-6">
                      <h6>Revisão</h6>
                      <div class="mb-2">
                        <textarea
                          class="form-control"
                          id="wfRevisionMsg"
                          rows="2"
                          placeholder="Detalhes"
                        ></textarea>
                      </div>
                      <button
                        class="btn btn-outline-secondary w-100"
                        onclick="addRevisionAction()"
                      >
                        Registrar revisão
                      </button>
                    </div>
                    <div class="col-lg-6">
                      <h6>Atribuir</h6>
                      <div class="mb-2">
                        <input
                          class="form-control"
                          id="wfAssignee"
                          placeholder="UUID do responsável"
                        />
                      </div>
                      <button
                        class="btn btn-outline-dark w-100"
                        onclick="assignAction()"
                      >
                        Atribuir
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-workflow" role="tabpanel">
          <div class="card card-shadow">
            <div class="card-body">
              <h5 class="card-title">Workflow rápido</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">ID da requisição *</label>
                  <input
                    class="form-control"
                    id="workflowRequestId"
                    placeholder="UUID"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">ID do ator (opcional)</label>
                  <input
                    class="form-control"
                    id="workflowActorId"
                    placeholder="UUID"
                  />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button
                    class="btn btn-outline-secondary w-100"
                    onclick="prefillWorkflowFromSelection()"
                  >
                    Usar selecionada
                  </button>
                </div>
              </div>
              <hr />
              <div class="row g-3">
                <div class="col-lg-6">
                  <h6>Alterar status</h6>
                  <select class="form-select mb-2" id="workflowNewStatus">
                    <option value="">Selecione...</option>
                    <option value="NEW">Novo</option>
                    <option value="IN_PROGRESS">Em progresso</option>
                    <option value="IN_REVIEW">Em revisão</option>
                    <option value="CHANGES_REQUESTED">
                      Mudanças solicitadas
                    </option>
                    <option value="APPROVED">Aprovado</option>
                    <option value="DELIVERED">Entregue</option>
                    <option value="CLOSED">Encerrado</option>
                  </select>
                  <input
                    class="form-control mb-2"
                    id="workflowStatusMessage"
                    placeholder="Mensagem"
                  />
                  <button
                    class="btn btn-primary w-100"
                    onclick="changeStatusWorkflow()"
                  >
                    Alterar
                  </button>
                </div>
                <div class="col-lg-6">
                  <h6>Comentário</h6>
                  <textarea
                    class="form-control mb-2"
                    id="workflowComment"
                    rows="2"
                    placeholder="Mensagem"
                  ></textarea>
                  <button
                    class="btn btn-outline-primary w-100"
                    onclick="addCommentWorkflow()"
                  >
                    Comentar
                  </button>
                </div>
                <div class="col-lg-6">
                  <h6>Revisão</h6>
                  <textarea
                    class="form-control mb-2"
                    id="workflowRevisionMessage"
                    rows="2"
                    placeholder="Detalhes"
                  ></textarea>
                  <button
                    class="btn btn-outline-secondary w-100"
                    onclick="addRevisionWorkflow()"
                  >
                    Registrar
                  </button>
                </div>
                <div class="col-lg-6">
                  <h6>Atribuir</h6>
                  <input
                    class="form-control mb-2"
                    id="workflowAssigneeId"
                    placeholder="UUID do responsável"
                  />
                  <button
                    class="btn btn-outline-dark w-100"
                    onclick="assignWorkflow()"
                  >
                    Atribuir
                  </button>
                </div>
              </div>
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-secondary" onclick="listEvents()">
                  Carregar eventos
                </button>
                <div
                  class="spinner-border spinner-border-sm text-primary"
                  role="status"
                  id="workflowLoading"
                  style="display: none"
                ></div>
              </div>
              <div
                class="mt-3"
                id="workflowResponse"
                style="display: none"
              ></div>
              <div class="mt-3" id="workflowEvents" style="display: none"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-eventos" role="tabpanel">
          <div class="card card-shadow">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <h5 class="card-title mb-0">Eventos da requisição</h5>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  onclick="loadEventsFromSelection()"
                >
                  Recarregar
                </button>
              </div>
              <div id="eventsList"></div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-relatorios" role="tabpanel">
          <div class="card card-shadow mb-3">
            <div class="card-body">
              <h5 class="card-title">Período de análise</h5>
              <div class="row g-2 mb-3">
                <div class="col-md-4">
                  <label class="form-label">De</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="reportFrom"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Até</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="reportTo"
                  />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button class="btn btn-primary w-100" onclick="loadReports()">
                    Carregar relatórios
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6 col-lg-3">
              <div class="card card-shadow">
                <div class="card-body">
                  <h6 class="card-title text-muted">Requisições atrasadas</h6>
                  <div class="display-5" id="overdueTotal">-</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3">
              <div class="card card-shadow">
                <div class="card-body">
                  <h6 class="card-title text-muted">Tempo médio de ciclo</h6>
                  <div class="display-5" id="avgCycleTime">-</div>
                  <small class="text-muted" id="avgCycleDetails"></small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3">
              <div class="card card-shadow">
                <div class="card-body">
                  <h6 class="card-title text-muted">Retrabalho (%)</h6>
                  <div class="display-5" id="reworkPercentage">-</div>
                  <small class="text-muted" id="reworkDetails"></small>
                </div>
              </div>
            </div>

            <div class="col-md-6 col-lg-3">
              <div class="card card-shadow">
                <div class="card-body">
                  <h6 class="card-title text-muted">Total no período</h6>
                  <div class="display-5" id="totalRequests">-</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-shadow mt-3">
            <div class="card-body">
              <h6 class="card-title">Requisições por status</h6>
              <div
                id="statusChart"
                style="max-height: 300px; overflow-y: auto"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "http://localhost:8080";
      let requestsCache = [];
      let selectedRequest = null;

      function showToast(message, type = "success") {
        const toastEl = document.createElement("div");
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.setAttribute("role", "alert");
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.getElementById("toastContainer").appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
        toast.show();
        toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
      }

      function copyText(text) {
        if (!text) return;
        navigator.clipboard
          .writeText(text)
          .then(() => showToast("Copiado", "primary"));
      }

      function statusBadge(status) {
        const map = {
          NEW: "secondary",
          IN_PROGRESS: "warning",
          IN_REVIEW: "info",
          CHANGES_REQUESTED: "danger",
          APPROVED: "success",
          DELIVERED: "primary",
          CLOSED: "dark",
        };
        const color = map[status] || "secondary";
        return `<span class="badge text-bg-${color} status-badge">${status}</span>`;
      }

      function priorityBadge(priority) {
        const map = {
          LOW: "secondary",
          MEDIUM: "info",
          HIGH: "warning",
          URGENT: "danger",
        };
        const color = map[priority] || "secondary";
        return `<span class="badge text-bg-${color} status-badge">${priority}</span>`;
      }

      function setLoading(targetId, show) {
        const el = document.getElementById(targetId);
        if (!el) return;
        el.style.display = show ? "inline-block" : "none";
      }

      function renderClients(clients) {
        const container = document.getElementById("clientList");
        if (!clients || clients.length === 0) {
          container.innerHTML = '<p class="text-muted">Nenhum cliente</p>';
          return;
        }
        let html =
          '<table class="table table-sm align-middle"><thead><tr><th>Nome</th><th>Segmento</th><th>ID</th><th></th></tr></thead><tbody>';
        clients.forEach((c) => {
          html += `<tr><td>${c.name}</td><td>${
            c.segment || "-"
          }</td><td><code>${
            c.id
          }</code></td><td><button class="btn btn-outline-secondary btn-sm" onclick="copyText('${
            c.id
          }')">Copiar ID</button></td></tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      async function createClient() {
        const name = document.getElementById("clientName").value;
        const segment = document.getElementById("clientSegment").value;
        if (!name) return showToast("Nome é obrigatório", "danger");
        try {
          const res = await fetch(`${API_URL}/clients`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, segment }),
          });
          const data = await res.json();
          if (res.ok) {
            showToast("Cliente criado", "success");
            document.getElementById("clientName").value = "";
            document.getElementById("clientSegment").value = "";
            listClients();
          } else {
            showToast(data.message || "Erro ao criar", "danger");
          }
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      async function listClients() {
        const container = document.getElementById("clientList");
        container.innerHTML =
          '<div class="skeleton rounded" style="height:80px;"></div>';
        try {
          const res = await fetch(`${API_URL}/clients`);
          const data = await res.json();
          renderClients(data);
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      function clearFilters() {
        [
          "filterClientId",
          "filterStatus",
          "filterPriority",
          "filterType",
          "filterCreatedFrom",
          "filterCreatedTo",
          "filterDueBefore",
        ].forEach((id) => (document.getElementById(id).value = ""));
        document.getElementById("filterPage").value = 0;
        document.getElementById("filterSize").value = 20;
        document.getElementById("filterSortBy").value = "createdAt";
        document.getElementById("filterDirection").value = "desc";
        document.getElementById("requestList").innerHTML = "";
        document.getElementById("reqSummary").textContent = "";
      }

      async function createRequest() {
        const clientId = document.getElementById("requestClientId").value;
        const title = document.getElementById("requestTitle").value;
        if (!clientId || !title)
          return showToast("Cliente e título são obrigatórios", "danger");
        const description = document.getElementById("requestDescription").value;
        const type = document.getElementById("requestType").value || null;
        const priority =
          document.getElementById("requestPriority").value || null;
        const dueDate = document.getElementById("requestDueDate").value;
        let dueDateISO;
        if (dueDate) dueDateISO = new Date(dueDate).toISOString();
        const body = {
          clientId,
          title,
          description: description || undefined,
          type: type || undefined,
          priority: priority || undefined,
          dueDate: dueDateISO,
        };
        try {
          const res = await fetch(`${API_URL}/requests`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (res.ok) {
            showToast("Requisição criada", "success");
            document.getElementById("requestClientId").value = "";
            document.getElementById("requestTitle").value = "";
            document.getElementById("requestDescription").value = "";
            document.getElementById("requestType").value = "";
            document.getElementById("requestPriority").value = "";
            document.getElementById("requestDueDate").value = "";
            advancedSearch();
            selectRequest(data);
          } else {
            showToast(data.message || "Erro ao criar", "danger");
          }
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      async function advancedSearch() {
        const status = document.getElementById("filterStatus").value;
        const priority = document.getElementById("filterPriority").value;
        const type = document.getElementById("filterType").value;
        const clientId = document.getElementById("filterClientId").value;
        const createdFrom = document.getElementById("filterCreatedFrom").value;
        const createdTo = document.getElementById("filterCreatedTo").value;
        const dueBefore = document.getElementById("filterDueBefore").value;
        const page = document.getElementById("filterPage").value || "0";
        const size = document.getElementById("filterSize").value || "20";
        const sortBy = document.getElementById("filterSortBy").value;
        const direction = document.getElementById("filterDirection").value;
        const list = document.getElementById("requestList");
        list.innerHTML =
          '<div class="skeleton rounded" style="height:120px;"></div>';
        let url = `${API_URL}/requests?page=${page}&size=${size}&sort=${sortBy},${direction}`;
        if (clientId) url += `&clientId=${clientId}`;
        if (status) url += `&status=${status}`;
        if (priority) url += `&priority=${priority}`;
        if (type) url += `&type=${type}`;
        if (createdFrom)
          url += `&createdFrom=${encodeURIComponent(
            new Date(createdFrom).toISOString()
          )}`;
        if (createdTo)
          url += `&createdTo=${encodeURIComponent(
            new Date(createdTo).toISOString()
          )}`;
        if (dueBefore)
          url += `&dueBefore=${encodeURIComponent(
            new Date(dueBefore).toISOString()
          )}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro na busca");
          requestsCache = data.content || [];
          renderRequestsList(data);
        } catch (e) {
          list.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          showToast(e.message, "danger");
        }
      }

      function renderRequestsList(pageData) {
        const list = document.getElementById("requestList");
        if (!pageData.content || pageData.content.length === 0) {
          list.innerHTML =
            '<div class="alert alert-secondary">Nenhuma requisição encontrada</div>';
          document.getElementById("reqSummary").textContent = "";
          return;
        }
        document.getElementById("reqSummary").textContent = `${
          pageData.totalElements
        } itens · página ${pageData.number + 1} / ${pageData.totalPages}`;
        list.innerHTML = pageData.content
          .map((req) => {
            const created = new Date(req.createdAt).toLocaleString("pt-BR");
            const due = req.dueDate
              ? new Date(req.dueDate).toLocaleString("pt-BR")
              : "Não definido";
            return `<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" onclick="selectRequestFromList('${
              req.id
            }')">
          <div class="me-2">
            <div class="d-flex align-items-center gap-2 mb-1"><strong>${
              req.title
            }</strong> ${statusBadge(req.status)} ${priorityBadge(
              req.priority
            )}</div>
            <div class="text-muted small">ID ${req.id.substring(
              0,
              8
            )}... · Cliente ${req.clientId.substring(
              0,
              8
            )}... · Criado ${created}</div>
            <div class="text-muted small">Vencimento: ${due}</div>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); copyText('${
              req.id
            }')">Copiar ID</button>
            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); selectRequest(req); openWorkflowTab();">Abrir Workflow</button>
          </div>
        </div>`;
          })
          .join("");
      }

      function selectRequestFromList(id) {
        const req = requestsCache.find((r) => r.id === id);
        if (req) selectRequest(req);
      }

      function selectRequest(req) {
        selectedRequest = req;
        document.getElementById("detailCard").style.display = "block";
        document.getElementById("detailTitle").textContent = req.title;
        document.getElementById("detailId").innerHTML = `${req.id}`;
        document.getElementById("detailDescription").textContent =
          req.description || "Sem descrição";
        document.getElementById("detailClient").textContent = req.clientId;
        const due = req.dueDate
          ? new Date(req.dueDate).toLocaleString("pt-BR")
          : "Não definido";
        document.getElementById("detailDue").textContent = due;
        document.getElementById("detailRevision").textContent =
          req.revisionCount ?? 0;
        document.getElementById("detailAssignee").textContent =
          req.assigneeId || "Não atribuído";
        const created = new Date(req.createdAt).toLocaleString("pt-BR");
        const updated = new Date(req.updatedAt).toLocaleString("pt-BR");
        document.getElementById(
          "detailDates"
        ).textContent = `${created} / ${updated}`;
        document.getElementById("detailBadges").innerHTML = `${statusBadge(
          req.status
        )} ${priorityBadge(req.priority)} <span class="badge text-bg-light">${
          req.type
        }</span>`;
        document.getElementById("wfStatus").value = "";
        document.getElementById("wfStatusMsg").value = "";
        document.getElementById("wfComment").value = "";
        document.getElementById("wfRevisionMsg").value = "";
        document.getElementById("wfAssignee").value = "";
        document.getElementById("workflowRequestId").value = req.id;
        loadEventsFromSelection();
      }

      function copySelectedId() {
        if (selectedRequest) copyText(selectedRequest.id);
      }

      function openWorkflowTab() {
        const tab = new bootstrap.Tab(document.getElementById("tab-workflow"));
        tab.show();
        prefillWorkflowFromSelection();
      }

      function prefillWorkflowFromSelection() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        document.getElementById("workflowRequestId").value = selectedRequest.id;
      }

      async function changeStatusAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const toStatus = document.getElementById("wfStatus").value;
        const message = document.getElementById("wfStatusMsg").value;
        if (!toStatus) return showToast("Escolha o status", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/status`, {
          toStatus,
          message,
        });
      }

      async function addCommentAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const message = document.getElementById("wfComment").value;
        if (!message) return showToast("Mensagem obrigatória", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/comments`, {
          message,
        });
      }

      async function addRevisionAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const message = document.getElementById("wfRevisionMsg").value;
        await postWorkflow(`/requests/${selectedRequest.id}/revisions`, {
          message,
        });
      }

      async function assignAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const assigneeId = document.getElementById("wfAssignee").value;
        if (!assigneeId)
          return showToast("Responsável é obrigatório", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/assign`, {
          assigneeId,
        });
      }

      async function postWorkflow(path, body) {
        try {
          const res = await fetch(`${API_URL}${path}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Ação realizada", "success");
          if (selectedRequest) await refreshSelected();
          loadEventsFromSelection();
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      async function refreshSelected() {
        if (!selectedRequest) return;
        try {
          const res = await fetch(`${API_URL}/requests/${selectedRequest.id}`);
          const data = await res.json();
          if (res.ok) selectRequest(data);
        } catch (e) {
          console.error(e);
        }
      }

      async function loadEventsFromSelection() {
        if (!selectedRequest) {
          document.getElementById("eventsList").innerHTML =
            '<div class="alert alert-warning">Selecione uma requisição</div>';
          return;
        }
        document.getElementById("eventsList").innerHTML =
          '<div class="skeleton rounded" style="height:80px;"></div>';
        try {
          const res = await fetch(
            `${API_URL}/requests/${selectedRequest.id}/events`
          );
          const data = await res.json();
          renderEvents(data, "eventsList");
        } catch (e) {
          document.getElementById(
            "eventsList"
          ).innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        }
      }

      function renderEvents(events, containerId) {
        const container = document.getElementById(containerId);
        if (!events || events.length === 0) {
          container.innerHTML =
            '<div class="alert alert-secondary">Nenhum evento</div>';
          return;
        }
        container.innerHTML = events
          .map((evt) => {
            const created = new Date(evt.createdAt).toLocaleString("pt-BR");
            return `<div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-center"><strong>${
            evt.eventType
          }</strong><small class="text-muted">${created}</small></div>
          <div class="text-muted small">${
            evt.fromStatus ? `De ${evt.fromStatus}` : ""
          } ${evt.toStatus ? ` ${evt.toStatus}` : ""}</div>
          ${
            evt.revisionNumber !== null && evt.revisionNumber !== undefined
              ? `<div class="small">Revisao #${evt.revisionNumber}</div>`
              : ""
          }
          ${evt.actorId ? `<div class="small">Ator: ${evt.actorId}</div>` : ""}
          ${evt.message ? `<div class="mt-1">${evt.message}</div>` : ""}
        </div>`;
          })
          .join("");
      }

      function getWorkflowContext() {
        const requestId = document.getElementById("workflowRequestId").value;
        const actorId = document.getElementById("workflowActorId").value;
        if (!requestId) {
          showToast("ID da requisicao e obrigatorio", "warning");
          return null;
        }
        return { requestId, actorId };
      }

      function toggleWorkflowLoading(show) {
        setLoading("workflowLoading", show);
      }
      function clearWorkflowResponse() {
        document.getElementById("workflowResponse").style.display = "none";
        document.getElementById("workflowEvents").style.display = "none";
      }

      async function changeStatusWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const toStatus = document.getElementById("workflowNewStatus").value;
        const message = document.getElementById("workflowStatusMessage").value;
        if (!toStatus) return showToast("Selecione o status", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/status`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                toStatus,
                message,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Status alterado", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function addCommentWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const message = document.getElementById("workflowComment").value;
        if (!message) return showToast("Mensagem e obrigatoria", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/comments`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Comentario adicionado", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function addRevisionWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const message = document.getElementById(
          "workflowRevisionMessage"
        ).value;
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/revisions`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message || undefined,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Revisao registrada", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function assignWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const assigneeId = document.getElementById("workflowAssigneeId").value;
        if (!assigneeId)
          return showToast("Responsavel e obrigatorio", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/assign`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                assigneeId,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Atribuicao feita", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function listEvents() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        toggleWorkflowLoading(true);
        document.getElementById("workflowEvents").style.display = "none";
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/events`
          );
          const data = await res.json();
          if (res.ok) {
            renderEvents(data, "workflowEvents");
            document.getElementById("workflowEvents").style.display = "block";
          } else {
            showToast(data.message || "Erro", "danger");
          }
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      function init() {
        listClients();
        clearFilters();
        advancedSearch();
        initReports();
      }

      function initReports() {
        const now = new Date();
        const thirtyDaysAgo = new Date(
          now.getTime() - 30 * 24 * 60 * 60 * 1000
        );
        document.getElementById("reportFrom").valueAsDate = thirtyDaysAgo;
        document.getElementById("reportTo").valueAsDate = now;
      }

      async function loadReports() {
        const from = document.getElementById("reportFrom").value;
        const to = document.getElementById("reportTo").value;
        if (!from || !to) {
          showToast("Defina o período", "warning");
          return;
        }
        const fromISO = new Date(from).toISOString();
        const toISO = new Date(to).toISOString();
        try {
          await Promise.all([
            loadOverdue(toISO),
            loadAvgCycleTime(fromISO, toISO),
            loadReworkMetrics(fromISO, toISO),
            loadRequestsByStatus(fromISO, toISO),
          ]);
          showToast("Relatórios carregados", "success");
        } catch (e) {
          showToast("Erro ao carregar relatórios", "danger");
        }
      }

      async function loadOverdue(at) {
        try {
          const res = await fetch(
            `${API_URL}/reports/overdue?at=${encodeURIComponent(at)}`
          );
          const data = await res.json();
          document.getElementById("overdueTotal").textContent = data.total;
        } catch (e) {
          console.error("Erro ao carregar atrasadas:", e);
        }
      }

      async function loadAvgCycleTime(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/avg-cycle-time?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          const days = data.avgDays;
          const hours = data.avgHours;
          document.getElementById(
            "avgCycleTime"
          ).textContent = `${days}d ${hours}h`;
          document.getElementById(
            "avgCycleDetails"
          ).textContent = `${data.avgSeconds.toFixed(0)} segundos`;
        } catch (e) {
          console.error("Erro ao carregar ciclo:", e);
        }
      }

      async function loadReworkMetrics(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/rework-metrics?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          const pct = data.reworkPercentage.toFixed(1);
          document.getElementById("reworkPercentage").textContent = `${pct}%`;
          document.getElementById(
            "reworkDetails"
          ).textContent = `${data.reworkCount} de ${data.totalCount}`;
          document.getElementById("totalRequests").textContent =
            data.totalCount;
        } catch (e) {
          console.error("Erro ao carregar retrabalho:", e);
        }
      }

      async function loadRequestsByStatus(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/requests-by-status?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          renderStatusChart(data);
        } catch (e) {
          console.error("Erro ao carregar status:", e);
        }
      }

      function renderStatusChart(statusData) {
        const container = document.getElementById("statusChart");
        if (!statusData || statusData.length === 0) {
          container.innerHTML = '<p class="text-muted">Nenhum dado</p>';
          return;
        }
        const statusLabels = {
          NEW: "Novo",
          IN_PROGRESS: "Em progresso",
          IN_REVIEW: "Em revisão",
          CHANGES_REQUESTED: "Mudanças solicitadas",
          APPROVED: "Aprovado",
          DELIVERED: "Entregue",
          CLOSED: "Encerrado",
        };
        let html = '<table class="table table-sm align-middle"><tbody>';
        statusData.forEach((item) => {
          const label = statusLabels[item.status] || item.status;
          const pct =
            statusData.reduce((sum, s) => sum + s.total, 0) > 0
              ? (
                  (item.total /
                    statusData.reduce((sum, s) => sum + s.total, 0)) *
                  100
                ).toFixed(0)
              : 0;
          html += `<tr><td>${label}</td><td><strong>${item.total}</strong></td><td><small class="text-muted">${pct}%</small></td></tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
