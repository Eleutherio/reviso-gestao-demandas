<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviso | Admin Console</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f7fb;
        overflow-x: hidden;
      }
      .status-badge {
        text-transform: uppercase;
        font-size: 0.75rem;
      }
      .card-shadow {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid #eef1f5;
      }
      .clickable {
        cursor: pointer;
      }
      .list-scroll {
        max-height: calc(100vh - 280px);
        overflow-y: auto;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          #f2f4f7 25%,
          #e9ecf2 37%,
          #f2f4f7 63%
        );
        background-size: 400% 100%;
        animation: shimmer 1.4s ease infinite;
      }
      @keyframes shimmer {
        0% {
          background-position: 100% 0;
        }
        100% {
          background-position: -100% 0;
        }
      }
      #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 100vw;
        pointer-events: none;
      }
      #toastContainer .toast {
        pointer-events: auto;
        margin-bottom: 10px;
        min-width: 250px;
        max-width: calc(100vw - 40px);
      }
      @media (max-width: 992px) {
        .list-scroll {
          max-height: 50vh;
        }
        #toastContainer {
          top: 10px;
          right: 10px;
        }
        #toastContainer .toast {
          min-width: 200px;
          max-width: calc(100vw - 20px);
          font-size: 0.9rem;
        }
      }

      .companies-table {
        --bs-table-cell-padding-x: 0.25rem;
        --bs-table-cell-padding-y: 0.2rem;
      }

      .companies-table > :not(caption) > * > * {
        padding-top: var(--bs-table-cell-padding-y);
        padding-bottom: var(--bs-table-cell-padding-y);
        padding-left: var(--bs-table-cell-padding-x);
        padding-right: var(--bs-table-cell-padding-x);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark mb-3">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Reviso - Admin Console</span>
        <button
          id="logoutButton"
          class="btn btn-outline-light btn-sm ms-auto"
          onclick="logout()"
        >
          Sair
        </button>
      </div>
    </nav>

    <div class="container-fluid">
      <ul class="nav nav-pills mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="tab-empresas"
            data-bs-toggle="pill"
            data-bs-target="#pane-empresas"
            type="button"
            role="tab"
          >
            Empresas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-cadastrar"
            data-bs-toggle="pill"
            data-bs-target="#pane-cadastrar"
            type="button"
            role="tab"
          >
            Cadastrar Requisição de Empresa
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-consultar"
            data-bs-toggle="pill"
            data-bs-target="#pane-consultar"
            type="button"
            role="tab"
          >
            Consultar Requisições
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-workflow"
            data-bs-toggle="pill"
            data-bs-target="#pane-workflow"
            type="button"
            role="tab"
          >
            Workflow
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-eventos"
            data-bs-toggle="pill"
            data-bs-target="#pane-eventos"
            type="button"
            role="tab"
          >
            Eventos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-relatorios"
            data-bs-toggle="pill"
            data-bs-target="#pane-relatorios"
            type="button"
            role="tab"
          >
            Relatórios
          </button>
        </li>
      </ul>

      <div class="tab-content" id="tabContent">
        <div
          class="tab-pane fade show active"
          id="pane-empresas"
          role="tabpanel"
        >
          <div id="pane-empresas-content" class="p-2">
            <div class="skeleton rounded" style="height: 80px"></div>
          </div>
        </div>
        <div class="tab-pane fade" id="pane-cadastrar" role="tabpanel">
          <div id="pane-cadastrar-content" class="p-2">
            <div class="skeleton rounded" style="height: 80px"></div>
          </div>
        </div>
        <div class="tab-pane fade" id="pane-consultar" role="tabpanel">
          <div id="pane-consultar-content" class="p-2">
            <div class="skeleton rounded" style="height: 120px"></div>
          </div>
        </div>
        <div class="tab-pane fade" id="pane-workflow" role="tabpanel">
          <div id="pane-workflow-content" class="p-2">
            <div class="skeleton rounded" style="height: 80px"></div>
          </div>
        </div>
        <div class="tab-pane fade" id="pane-eventos" role="tabpanel">
          <div id="pane-eventos-content" class="p-2">
            <div class="skeleton rounded" style="height: 80px"></div>
          </div>
        </div>
        <div class="tab-pane fade" id="pane-relatorios" role="tabpanel">
          <div id="pane-relatorios-content" class="p-2">
            <div class="skeleton rounded" style="height: 80px"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "http://localhost:8080";
      let requestsCache = [];
      let companiesCache = [];
      const revealedCompanyIds = new Set();
      let selectedRequest = null;

      function showToast(message, type = "success") {
        const toastEl = document.createElement("div");
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.setAttribute("role", "alert");
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.getElementById("toastContainer").appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
        toast.show();
        toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
      }

      function copyText(text) {
        if (!text) return;
        navigator.clipboard
          .writeText(text)
          .then(() => showToast("Copiado", "primary"));
      }

      function copyCompanyIdFromCell(companyId, cellId) {
        if (!companyId) return;
        const el = document.getElementById(cellId);
        navigator.clipboard.writeText(companyId).then(() => {
          if (el) {
            el.classList.add("bg-warning-subtle");
            setTimeout(() => el.classList.remove("bg-warning-subtle"), 450);
          }
          showToast("ID copiado", "primary");
        });
      }

      function revealCompanyId(companyId) {
        if (!companyId) return;
        revealedCompanyIds.add(companyId);
        renderCompaniesAdmin(companiesCache);
      }

      function toggleCompanyId(companyId) {
        if (!companyId) return;
        if (revealedCompanyIds.has(companyId)) {
          revealedCompanyIds.delete(companyId);
        } else {
          revealedCompanyIds.add(companyId);
        }
        renderCompaniesAdmin(companiesCache);
      }

      function statusBadge(status) {
        const map = {
          NEW: "secondary",
          IN_PROGRESS: "warning",
          IN_REVIEW: "info",
          CHANGES_REQUESTED: "danger",
          APPROVED: "success",
          DELIVERED: "primary",
          CLOSED: "dark",
        };
        const color = map[status] || "secondary";
        return `<span class="badge text-bg-${color} status-badge">${status}</span>`;
      }

      function priorityBadge(priority) {
        const map = {
          LOW: "secondary",
          MEDIUM: "info",
          HIGH: "warning",
          URGENT: "danger",
        };
        const color = map[priority] || "secondary";
        return `<span class="badge text-bg-${color} status-badge">${priority}</span>`;
      }

      function setLoading(targetId, show) {
        const el = document.getElementById(targetId);
        if (!el) return;
        el.style.display = show ? "inline-block" : "none";
      }

      function clearFilters() {
        [
          "filterCompanyId",
          "filterStatus",
          "filterPriority",
          "filterType",
          "filterCreatedFrom",
          "filterCreatedTo",
          "filterDueBefore",
        ].forEach((id) => (document.getElementById(id).value = ""));
        document.getElementById("filterPage").value = 0;
        document.getElementById("filterSize").value = 20;
        document.getElementById("filterSortBy").value = "createdAt";
        document.getElementById("filterDirection").value = "desc";
        document.getElementById("requestList").innerHTML = "";
        document.getElementById("reqSummary").textContent = "";
      }

      async function createRequest() {
        const companyId = document.getElementById("requestCompanyId").value;
        const title = document.getElementById("requestTitle").value;
        if (!companyId || !title)
          return showToast("Empresa e título são obrigatórios", "danger");
        const description = document.getElementById("requestDescription").value;
        const type = document.getElementById("requestType").value || null;
        const priority =
          document.getElementById("requestPriority").value || null;
        const department = document.getElementById("requestDepartment").value;
        if (!department)
          return showToast("Departamento é obrigatório", "danger");
        const dueDate = document.getElementById("requestDueDate").value;
        let dueDateISO;
        if (dueDate) dueDateISO = new Date(dueDate).toISOString();
        const body = {
          companyId,
          title,
          description: description || undefined,
          type: type || undefined,
          priority: priority || undefined,
          department,
          dueDate: dueDateISO,
        };
        try {
          const res = await fetch(`${API_URL}/requests`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (res.ok) {
            showToast("Requisição criada", "success");
            document.getElementById("requestCompanyId").value = "";
            document.getElementById("requestTitle").value = "";
            document.getElementById("requestDescription").value = "";
            document.getElementById("requestType").value = "";
            document.getElementById("requestPriority").value = "";
            document.getElementById("requestDepartment").value = "";
            document.getElementById("requestDueDate").value = "";
            advancedSearch();
            selectRequest(data);
          } else {
            const deptError = data?.errors?.department;
            const companyError = data?.errors?.companyId;
            const titleError = data?.errors?.title;
            showToast(
              deptError ||
                companyError ||
                titleError ||
                data.message ||
                data.error ||
                "Erro ao criar",
              "danger"
            );
          }
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      async function advancedSearch() {
        const status = document.getElementById("filterStatus").value;
        const priority = document.getElementById("filterPriority").value;
        const type = document.getElementById("filterType").value;
        const companyId = document.getElementById("filterCompanyId").value;
        const createdFrom = document.getElementById("filterCreatedFrom").value;
        const createdTo = document.getElementById("filterCreatedTo").value;
        const dueBefore = document.getElementById("filterDueBefore").value;
        const page = document.getElementById("filterPage").value || "0";
        const size = document.getElementById("filterSize").value || "20";
        const sortBy = document.getElementById("filterSortBy").value;
        const direction = document.getElementById("filterDirection").value;
        const list = document.getElementById("requestList");
        list.innerHTML =
          '<div class="skeleton rounded" style="height:120px;"></div>';
        let url = `${API_URL}/requests?page=${page}&size=${size}&sort=${sortBy},${direction}`;
        if (companyId) url += `&companyId=${companyId}`;
        if (status) url += `&status=${status}`;
        if (priority) url += `&priority=${priority}`;
        if (type) url += `&type=${type}`;
        if (createdFrom)
          url += `&createdFrom=${encodeURIComponent(
            new Date(createdFrom).toISOString()
          )}`;
        if (createdTo)
          url += `&createdTo=${encodeURIComponent(
            new Date(createdTo).toISOString()
          )}`;
        if (dueBefore)
          url += `&dueBefore=${encodeURIComponent(
            new Date(dueBefore).toISOString()
          )}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro na busca");
          requestsCache = data.content || [];
          renderRequestsList(data);
        } catch (e) {
          list.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          showToast(e.message, "danger");
        }
      }

      function renderRequestsList(pageData) {
        const list = document.getElementById("requestList");
        if (!pageData.content || pageData.content.length === 0) {
          list.innerHTML =
            '<div class="alert alert-secondary">Nenhuma requisição encontrada</div>';
          document.getElementById("reqSummary").textContent = "";
          return;
        }
        document.getElementById("reqSummary").textContent = `${
          pageData.totalElements
        } itens · página ${pageData.number + 1} / ${pageData.totalPages}`;
        list.innerHTML = pageData.content
          .map((req) => {
            const created = new Date(req.createdAt).toLocaleString("pt-BR");
            const due = req.dueDate
              ? new Date(req.dueDate).toLocaleString("pt-BR")
              : "Não definido";
            return `<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" onclick="selectRequestFromList('${
              req.id
            }')">
          <div class="me-2">
            <div class="d-flex align-items-center gap-2 mb-1"><strong>${
              req.title
            }</strong> ${statusBadge(req.status)} ${priorityBadge(
              req.priority
            )} <span class="badge text-bg-light">${req.department}</span></div>
            <div class="text-muted small">ID ${req.id.substring(
              0,
              8
            )}... · Empresa ${req.companyId.substring(
              0,
              8
            )}... · Criado ${created}</div>
            <div class="text-muted small">Vencimento: ${due}</div>
          </div>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); copyText('${
              req.id
            }')">Copiar ID</button>
            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); selectRequest(req); openWorkflowTab();">Abrir Workflow</button>
          </div>
        </div>`;
          })
          .join("");
      }

      function selectRequestFromList(id) {
        const req = requestsCache.find((r) => r.id === id);
        if (req) selectRequest(req);
      }

      function selectRequest(req) {
        selectedRequest = req;
        document.getElementById("detailCard").style.display = "block";
        document.getElementById("detailTitle").textContent = req.title;
        document.getElementById("detailId").innerHTML = `${req.id}`;
        document.getElementById("detailDescription").textContent =
          req.description || "Sem descrição";
        document.getElementById("detailClient").textContent = req.companyId;
        const due = req.dueDate
          ? new Date(req.dueDate).toLocaleString("pt-BR")
          : "Não definido";
        document.getElementById("detailDue").textContent = due;
        document.getElementById("detailRevision").textContent =
          req.revisionCount ?? 0;
        document.getElementById("detailAssignee").textContent =
          req.assigneeId || "Não atribuído";
        const created = new Date(req.createdAt).toLocaleString("pt-BR");
        const updated = new Date(req.updatedAt).toLocaleString("pt-BR");
        document.getElementById(
          "detailDates"
        ).textContent = `${created} / ${updated}`;
        document.getElementById("detailBadges").innerHTML = `${statusBadge(
          req.status
        )} ${priorityBadge(req.priority)} <span class="badge text-bg-light">${
          req.department
        }</span> <span class="badge text-bg-light">${req.type}</span>`;
        document.getElementById("wfStatus").value = "";
        document.getElementById("wfStatusMsg").value = "";
        document.getElementById("wfComment").value = "";
        document.getElementById("wfRevisionMsg").value = "";
        document.getElementById("wfAssignee").value = "";
        document.getElementById("workflowRequestId").value = req.id;
        loadEventsFromSelection();
      }

      function copySelectedId() {
        if (selectedRequest) copyText(selectedRequest.id);
      }

      function openWorkflowTab() {
        const tab = new bootstrap.Tab(document.getElementById("tab-workflow"));
        tab.show();
        prefillWorkflowFromSelection();
      }

      function prefillWorkflowFromSelection() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        document.getElementById("workflowRequestId").value = selectedRequest.id;
      }

      async function changeStatusAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const toStatus = document.getElementById("wfStatus").value;
        const message = document.getElementById("wfStatusMsg").value;
        if (!toStatus) return showToast("Escolha o status", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/status`, {
          toStatus,
          message,
        });
      }

      async function addCommentAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const message = document.getElementById("wfComment").value;
        if (!message) return showToast("Mensagem obrigatória", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/comments`, {
          message,
        });
      }

      async function addRevisionAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const message = document.getElementById("wfRevisionMsg").value;
        await postWorkflow(`/requests/${selectedRequest.id}/revisions`, {
          message,
        });
      }

      async function assignAction() {
        if (!selectedRequest)
          return showToast("Selecione uma requisição", "warning");
        const assigneeId = document.getElementById("wfAssignee").value;
        if (!assigneeId)
          return showToast("Responsável é obrigatório", "warning");
        await postWorkflow(`/requests/${selectedRequest.id}/assign`, {
          assigneeId,
        });
      }

      async function postWorkflow(path, body) {
        try {
          const res = await fetch(`${API_URL}${path}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Ação realizada", "success");
          if (selectedRequest) await refreshSelected();
          loadEventsFromSelection();
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      async function refreshSelected() {
        if (!selectedRequest) return;
        try {
          const res = await fetch(`${API_URL}/requests/${selectedRequest.id}`);
          const data = await res.json();
          if (res.ok) selectRequest(data);
        } catch (e) {
          console.error(e);
        }
      }

      async function loadEventsFromSelection() {
        if (!selectedRequest) {
          document.getElementById("eventsList").innerHTML =
            '<div class="alert alert-warning">Selecione uma requisição</div>';
          return;
        }
        document.getElementById("eventsList").innerHTML =
          '<div class="skeleton rounded" style="height:80px;"></div>';
        try {
          const res = await fetch(
            `${API_URL}/requests/${selectedRequest.id}/events`
          );
          const data = await res.json();
          renderEvents(data, "eventsList");
        } catch (e) {
          document.getElementById(
            "eventsList"
          ).innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        }
      }

      function renderEvents(events, containerId) {
        const container = document.getElementById(containerId);
        if (!events || events.length === 0) {
          container.innerHTML =
            '<div class="alert alert-secondary">Nenhum evento</div>';
          return;
        }
        container.innerHTML = events
          .map((evt) => {
            const created = new Date(evt.createdAt).toLocaleString("pt-BR");
            return `<div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-center"><strong>${
            evt.eventType
          }</strong><small class="text-muted">${created}</small></div>
          <div class="text-muted small">${
            evt.fromStatus ? `De ${evt.fromStatus}` : ""
          } ${evt.toStatus ? ` ${evt.toStatus}` : ""}</div>
          ${
            evt.revisionNumber !== null && evt.revisionNumber !== undefined
              ? `<div class="small">Revisao #${evt.revisionNumber}</div>`
              : ""
          }
          ${evt.actorId ? `<div class="small">Ator: ${evt.actorId}</div>` : ""}
          ${evt.message ? `<div class="mt-1">${evt.message}</div>` : ""}
        </div>`;
          })
          .join("");
      }

      function getWorkflowContext() {
        const requestId = document.getElementById("workflowRequestId").value;
        const actorId = document.getElementById("workflowActorId").value;
        if (!requestId) {
          showToast("ID da requisicao e obrigatorio", "warning");
          return null;
        }
        return { requestId, actorId };
      }

      function toggleWorkflowLoading(show) {
        setLoading("workflowLoading", show);
      }
      function clearWorkflowResponse() {
        document.getElementById("workflowResponse").style.display = "none";
        document.getElementById("workflowEvents").style.display = "none";
      }

      async function changeStatusWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const toStatus = document.getElementById("workflowNewStatus").value;
        const message = document.getElementById("workflowStatusMessage").value;
        if (!toStatus) return showToast("Selecione o status", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/status`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                toStatus,
                message,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Status alterado", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function addCommentWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const message = document.getElementById("workflowComment").value;
        if (!message) return showToast("Mensagem e obrigatoria", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/comments`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Comentario adicionado", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function addRevisionWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const message = document.getElementById(
          "workflowRevisionMessage"
        ).value;
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/revisions`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message || undefined,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Revisao registrada", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function assignWorkflow() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        const assigneeId = document.getElementById("workflowAssigneeId").value;
        if (!assigneeId)
          return showToast("Responsavel e obrigatorio", "warning");
        toggleWorkflowLoading(true);
        clearWorkflowResponse();
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/assign`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                assigneeId,
                actorId: ctx.actorId || undefined,
              }),
            }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Erro");
          showToast("Atribuicao feita", "success");
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      async function listEvents() {
        const ctx = getWorkflowContext();
        if (!ctx) return;
        toggleWorkflowLoading(true);
        document.getElementById("workflowEvents").style.display = "none";
        try {
          const res = await fetch(
            `${API_URL}/requests/${ctx.requestId}/events`
          );
          const data = await res.json();
          if (res.ok) {
            renderEvents(data, "workflowEvents");
            document.getElementById("workflowEvents").style.display = "block";
          } else {
            showToast(data.message || "Erro", "danger");
          }
        } catch (e) {
          showToast(e.message, "danger");
        } finally {
          toggleWorkflowLoading(false);
        }
      }

      function initReports() {
        function pad2(n) {
          return String(n).padStart(2, "0");
        }

        function toDateTimeLocalValue(d) {
          const year = d.getFullYear();
          const month = pad2(d.getMonth() + 1);
          const day = pad2(d.getDate());
          const hours = pad2(d.getHours());
          const minutes = pad2(d.getMinutes());
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        const now = new Date();
        const thirtyDaysAgo = new Date(
          now.getTime() - 30 * 24 * 60 * 60 * 1000
        );
        document.getElementById("reportFrom").value =
          toDateTimeLocalValue(thirtyDaysAgo);
        document.getElementById("reportTo").value = toDateTimeLocalValue(now);
      }

      async function loadReports() {
        const from = document.getElementById("reportFrom").value;
        const to = document.getElementById("reportTo").value;
        if (!from || !to) {
          showToast("Defina o período", "warning");
          return;
        }
        const fromISO = new Date(from).toISOString();
        const toISO = new Date(to).toISOString();
        try {
          await Promise.all([
            loadOverdue(toISO),
            loadAvgCycleTime(fromISO, toISO),
            loadReworkMetrics(fromISO, toISO),
            loadRequestsByStatus(fromISO, toISO),
          ]);
          showToast("Relatórios carregados", "success");
        } catch (e) {
          showToast("Erro ao carregar relatórios", "danger");
        }
      }

      async function loadOverdue(at) {
        try {
          const res = await fetch(
            `${API_URL}/reports/overdue?at=${encodeURIComponent(at)}`
          );
          const data = await res.json();
          document.getElementById("overdueTotal").textContent = data.total;
        } catch (e) {
          console.error("Erro ao carregar atrasadas:", e);
        }
      }

      async function loadAvgCycleTime(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/avg-cycle-time?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          const days = data.avgDays;
          const hours = data.avgHours;
          document.getElementById(
            "avgCycleTime"
          ).textContent = `${days}d ${hours}h`;
          document.getElementById(
            "avgCycleDetails"
          ).textContent = `${data.avgSeconds.toFixed(0)} segundos`;
        } catch (e) {
          console.error("Erro ao carregar ciclo:", e);
        }
      }

      async function loadReworkMetrics(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/rework-metrics?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          const pct = data.reworkPercentage.toFixed(1);
          document.getElementById("reworkPercentage").textContent = `${pct}%`;
          document.getElementById(
            "reworkDetails"
          ).textContent = `${data.reworkCount} de ${data.totalCount}`;
          document.getElementById("totalRequests").textContent =
            data.totalCount;
        } catch (e) {
          console.error("Erro ao carregar retrabalho:", e);
        }
      }

      async function loadRequestsByStatus(from, to) {
        try {
          const res = await fetch(
            `${API_URL}/reports/requests-by-status?from=${encodeURIComponent(
              from
            )}&to=${encodeURIComponent(to)}`
          );
          const data = await res.json();
          renderStatusChart(data);
        } catch (e) {
          console.error("Erro ao carregar status:", e);
        }
      }

      function renderStatusChart(statusData) {
        const container = document.getElementById("statusChart");
        if (!statusData || statusData.length === 0) {
          container.innerHTML = '<p class="text-muted">Nenhum dado</p>';
          return;
        }
        const statusLabels = {
          NEW: "Novo",
          IN_PROGRESS: "Em progresso",
          IN_REVIEW: "Em revisão",
          CHANGES_REQUESTED: "Mudanças solicitadas",
          APPROVED: "Aprovado",
          DELIVERED: "Entregue",
          CLOSED: "Encerrado",
        };
        let html = '<table class="table table-sm align-middle"><tbody>';
        statusData.forEach((item) => {
          const label = statusLabels[item.status] || item.status;
          const pct =
            statusData.reduce((sum, s) => sum + s.total, 0) > 0
              ? (
                  (item.total /
                    statusData.reduce((sum, s) => sum + s.total, 0)) *
                  100
                ).toFixed(0)
              : 0;
          html += `<tr><td>${label}</td><td><strong>${item.total}</strong></td><td><small class="text-muted">${pct}%</small></td></tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // Lazy-load de conteúdo das abas
      const paneUrls = {
        empresas: "/tabs/empresas.html",
        cadastrar: "/tabs/cadastrar.html",
        consultar: "/tabs/consultar.html",
        workflow: "/tabs/workflow.html",
        eventos: "/tabs/eventos.html",
        relatorios: "/tabs/relatorios.html",
      };

      function ensurePaneLoaded(key, after) {
        const containerId = `pane-${key}-content`;
        const el = document.getElementById(containerId);
        if (!el) return;
        if (el.dataset.loaded === "true") {
          if (after) after();
          return;
        }
        fetch(paneUrls[key])
          .then((r) => r.text())
          .then((html) => {
            el.innerHTML = html;
            el.dataset.loaded = "true";
            if (after) after();
          })
          .catch((e) => {
            el.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${e.message}</div>`;
          });
      }

      // Carregar aba quando ficar visível
      const tabKeyMap = {
        "tab-empresas": "empresas",
        "tab-cadastrar": "cadastrar",
        "tab-consultar": "consultar",
        "tab-workflow": "workflow",
        "tab-eventos": "eventos",
        "tab-relatorios": "relatorios",
      };
      document
        .querySelectorAll('#mainTabs button[data-bs-toggle="pill"]')
        .forEach((btn) => {
          btn.addEventListener("shown.bs.tab", (ev) => {
            const key = tabKeyMap[ev.target.id];
            if (key) ensurePaneLoaded(key);
          });
        });

      function init() {
        // Carregar conteúdo necessário antes de usar funções
        if (userRole === "AGENCY_ADMIN" || userRole === "AGENCY_USER") {
          ensurePaneLoaded("empresas", () => {
            configureEmpresasPane();
            if (userRole === "AGENCY_ADMIN") {
              resetCompanyFormAdmin();
            }
            loadCompanies();
          });
        }
        ensurePaneLoaded("consultar", () => {
          clearFilters();
          advancedSearch();
        });
        ensurePaneLoaded("relatorios", initReports);
      }

      document.addEventListener("DOMContentLoaded", init);

      // Controle de sessão e visibilidade de abas por role
      const authToken = localStorage.getItem("authToken");
      const userRole = localStorage.getItem("userRole");
      if (!authToken || !userRole) {
        window.location.href = "/login.html";
      }

      // Wrapper para sempre enviar Authorization
      const nativeFetch = window.fetch.bind(window);
      window.fetch = (input, init = {}) => {
        const headers = new Headers(init.headers || {});
        if (authToken) headers.set("Authorization", `Bearer ${authToken}`);
        return nativeFetch(input, { ...init, headers });
      };

      function applyRoleVisibility() {
        const tabIds = {
          empresas: "tab-empresas",
          cadastrar: "tab-cadastrar",
          consultar: "tab-consultar",
          workflow: "tab-workflow",
          eventos: "tab-eventos",
          relatorios: "tab-relatorios",
        };

        const roleVisibility = {
          AGENCY_ADMIN: [
            "empresas",
            "cadastrar",
            "consultar",
            "workflow",
            "eventos",
            "relatorios",
          ],
          AGENCY_USER: [
            "empresas",
            "cadastrar",
            "consultar",
            "workflow",
            "eventos",
            "relatorios",
          ],
          CLIENT_USER: ["consultar", "workflow"],
        };

        const allowed = roleVisibility[userRole] || [];
        Object.entries(tabIds).forEach(([key, id]) => {
          const btn = document.getElementById(id);
          const li = btn?.closest("li");
          if (!btn || !li) return;
          const visible = allowed.includes(key);
          li.style.display = visible ? "" : "none";
          if (!visible && btn.classList.contains("active")) {
            const firstAllowed = allowed
              .map((k) => tabIds[k])
              .map((tid) => document.getElementById(tid))
              .find(Boolean);
            if (firstAllowed) new bootstrap.Tab(firstAllowed).show();
          }
        });
      }

      function resetCompanyFormAdmin() {
        const idEl = document.getElementById("companyFormId");
        const nameEl = document.getElementById("companyName");
        const typeEl = document.getElementById("companyType");
        const segmentEl = document.getElementById("companySegment");
        const emailEl = document.getElementById("companyContactEmail");
        const siteEl = document.getElementById("companySite");
        const linksEl = document.getElementById("companyUsefulLinks");
        const activeEl = document.getElementById("companyActive");

        if (!idEl) return;
        idEl.value = "";
        nameEl.value = "";
        typeEl.value = "CLIENT";
        segmentEl.value = "";
        emailEl.value = "";
        siteEl.value = "";
        linksEl.value = "";
        activeEl.checked = true;
      }

      function configureEmpresasPane() {
        const idEl = document.getElementById("companyFormId");
        if (!idEl) return;
        const formCol = idEl.closest(".col-lg-4");
        if (!formCol) return;
        formCol.style.display = userRole === "AGENCY_ADMIN" ? "" : "none";

        const searchEl = document.getElementById("companiesSearch");
        if (searchEl && !searchEl.dataset.bound) {
          searchEl.dataset.bound = "true";
          searchEl.addEventListener("input", () =>
            renderCompaniesAdmin(companiesCache)
          );
        }

        if (!window.__companiesResizeBound) {
          window.__companiesResizeBound = true;
          window.addEventListener("resize", () =>
            renderCompaniesAdmin(companiesCache)
          );
        }
      }

      function parseUsefulLinksTextarea(value) {
        if (value == null) return null;
        const trimmed = value.trim();
        if (!trimmed) return [];
        return trimmed
          .split("\n")
          .map((s) => s.trim())
          .filter((s) => s.length > 0);
      }

      function renderCompaniesAdmin(companies) {
        const container = document.getElementById("companiesList");
        if (!container) return;
        if (!companies || companies.length === 0) {
          container.innerHTML = '<p class="text-muted">Nenhuma empresa</p>';
          return;
        }

        const query = (document.getElementById("companiesSearch")?.value || "")
          .trim()
          .toLowerCase();
        const filtered = query
          ? companies.filter((c) => {
              const haystack = [
                c.name,
                c.type,
                c.segment,
                c.contactEmail,
                c.site,
                c.id,
              ]
                .filter(Boolean)
                .join(" ")
                .toLowerCase();
              return haystack.includes(query);
            })
          : companies;

        if (filtered.length === 0) {
          container.innerHTML =
            '<div class="alert alert-secondary">Nenhum resultado</div>';
          return;
        }

        const isNarrow = window.matchMedia("(max-width: 768px)").matches;
        if (isNarrow) {
          container.innerHTML = filtered
            .map((c) => {
              const email = c.contactEmail || "-";
              const segment = c.segment || "-";
              const canEdit = userRole === "AGENCY_ADMIN";
              const revealed = revealedCompanyIds.has(c.id);
              const toggleLabel = revealed ? "Esconder ID" : "Exibir ID";
              const cellId = `company-id-${c.id}`;
              const idValue = revealed
                ? `<span id="${cellId}" class="font-monospace small text-break clickable" role="button" tabindex="0" onclick="copyCompanyIdFromCell('${c.id}','${cellId}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();copyCompanyIdFromCell('${c.id}','${cellId}');}">${c.id}</span>`
                : `<span class="text-muted font-monospace">********</span>`;

              const statusBadgeHtml = c.active
                ? '<span class="badge text-bg-success">Ativo</span>'
                : '<span class="badge text-bg-secondary">Inativo</span>';

              return `
                <div class="card mb-2">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                      <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-semibold text-truncate" title="${(
                          c.name || ""
                        ).replace(/"/g, "&quot;")}">${c.name}</div>
                        <div class="text-muted small">Segmento: <span class="text-truncate d-inline-block" style="max-width: 100%" title="${segment.replace(
                          /"/g,
                          "&quot;"
                        )}">${segment}</span></div>
                        <div class="text-muted small">Email: <span class="text-truncate d-inline-block" style="max-width: 100%" title="${email.replace(
                          /"/g,
                          "&quot;"
                        )}">${email}</span></div>
                        <div class="text-muted small">Situação: ${statusBadgeHtml}</div>
                        <div class="text-muted small mt-1">ID: ${idValue}</div>
                      </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-outline-secondary btn-sm" onclick="toggleCompanyId('${
                        c.id
                      }')">${toggleLabel}</button>
                      ${
                        canEdit
                          ? `<button class="btn btn-outline-primary btn-sm" onclick='editCompanyAdmin(${JSON.stringify(
                              c
                            ).replace(/'/g, "&#39;")})'>Editar</button>`
                          : ""
                      }
                    </div>
                  </div>
                </div>
              `;
            })
            .join("");
          return;
        }

        let html =
          '<table class="table table-sm align-middle companies-table" style="table-layout: fixed; width: 100%;"><thead><tr><th style="width: 26%;">Nome</th><th style="width: 18%;">Segmento</th><th style="width: 10%;">Situação</th><th style="width: 20%;">Email</th><th style="width: 14%;">ID</th><th style="width: 12%;"></th></tr></thead><tbody>';
        filtered.forEach((c) => {
          const email = c.contactEmail || "-";
          const segment = c.segment || "-";
          const canEdit = userRole === "AGENCY_ADMIN";
          const revealed = revealedCompanyIds.has(c.id);
          const toggleLabel = revealed ? "Esconder ID" : "Exibir ID";
          const cellId = `company-id-${c.id}`;
          const idCell = revealed
            ? `<span id="${cellId}" class="font-monospace small px-2 py-1 rounded clickable text-truncate" style="display:inline-block; max-width: 100%;" title="${c.id}" role="button" tabindex="0" onclick="copyCompanyIdFromCell('${c.id}','${cellId}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();copyCompanyIdFromCell('${c.id}','${cellId}');}">${c.id}</span>`
            : `<span class="text-muted font-monospace">********</span>`;
          html += `<tr>
            <td style="min-width: 0;"><div class="text-truncate w-100" title="${(
              c.name || ""
            ).replace(/"/g, "&quot;")}">${c.name}</div></td>
            <td style="min-width: 0;"><div class="text-truncate w-100" title="${segment.replace(
              /"/g,
              "&quot;"
            )}">${segment}</div></td>
            <td>${
              c.active
                ? '<span class="badge text-bg-success">Ativo</span>'
                : '<span class="badge text-bg-secondary">Inativo</span>'
            }</td>
            <td style="min-width: 0;"><div class="text-truncate w-100" title="${email.replace(
              /"/g,
              "&quot;"
            )}">${email}</div></td>
            <td>${idCell}</td>
            <td class="text-end" style="white-space: normal; min-width: 0;">
              <div class="d-flex flex-wrap gap-2 justify-content-end" style="min-width: 0;">
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleCompanyId('${
                  c.id
                }')">${toggleLabel}</button>
                ${
                  canEdit
                    ? `<button class="btn btn-outline-primary btn-sm" onclick='editCompanyAdmin(${JSON.stringify(
                        c
                      ).replace(/'/g, "&#39;")})'>Editar</button>`
                    : ""
                }
              </div>
            </td>
          </tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
      }

      function loadCompanies() {
        if (userRole === "AGENCY_ADMIN") return loadCompaniesAdmin();
        return loadCompaniesAgency();
      }

      async function loadCompaniesAgency() {
        const container = document.getElementById("companiesList");
        if (container)
          container.innerHTML =
            '<div class="skeleton rounded" style="height:80px;"></div>';
        try {
          configureEmpresasPane();
          const res = await fetch(`${API_URL}/agency/companies`);
          const data = await res.json();
          if (!res.ok) {
            throw new Error(
              data.message || data.error || "Erro ao listar empresas"
            );
          }
          companiesCache = Array.isArray(data) ? data : [];
          renderCompaniesAdmin(companiesCache);
        } catch (e) {
          if (container)
            container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          showToast(e.message, "danger");
        }
      }

      async function loadCompaniesAdmin() {
        const container = document.getElementById("companiesList");
        if (container)
          container.innerHTML =
            '<div class="skeleton rounded" style="height:80px;"></div>';
        try {
          configureEmpresasPane();
          const res = await fetch(`${API_URL}/admin/companies`);
          const data = await res.json();
          if (!res.ok) {
            throw new Error(
              data.message || data.error || "Erro ao listar empresas"
            );
          }
          companiesCache = Array.isArray(data) ? data : [];
          renderCompaniesAdmin(companiesCache);
        } catch (e) {
          if (container)
            container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
          showToast(e.message, "danger");
        }
      }

      function editCompanyAdmin(company) {
        if (userRole !== "AGENCY_ADMIN") {
          showToast("Somente AGENCY_ADMIN pode editar empresas", "warning");
          return;
        }
        ensurePaneLoaded("empresas", () => {
          const idEl = document.getElementById("companyFormId");
          if (!idEl) return;
          idEl.value = company.id || "";
          document.getElementById("companyName").value = company.name || "";
          document.getElementById("companyType").value =
            company.type || "CLIENT";
          document.getElementById("companySegment").value =
            company.segment || "";
          document.getElementById("companyContactEmail").value =
            company.contactEmail || "";
          document.getElementById("companySite").value = company.site || "";
          document.getElementById("companyActive").checked =
            company.active !== false;
          const links = Array.isArray(company.usefulLinks)
            ? company.usefulLinks
            : [];
          document.getElementById("companyUsefulLinks").value =
            links.join("\n");

          const tab = new bootstrap.Tab(
            document.getElementById("tab-empresas")
          );
          tab.show();
        });
      }

      async function saveCompanyAdmin() {
        if (userRole !== "AGENCY_ADMIN") {
          showToast(
            "Somente AGENCY_ADMIN pode cadastrar/editar empresas",
            "warning"
          );
          return;
        }
        const idEl = document.getElementById("companyFormId");
        if (!idEl) return;

        const id = idEl.value.trim();
        const name = document.getElementById("companyName").value;
        const type = document.getElementById("companyType").value;
        const segment = document.getElementById("companySegment").value;
        const contactEmail = document.getElementById(
          "companyContactEmail"
        ).value;
        const site = document.getElementById("companySite").value;
        const usefulLinks = parseUsefulLinksTextarea(
          document.getElementById("companyUsefulLinks").value
        );
        const active = document.getElementById("companyActive").checked;

        try {
          if (!name || !type || !segment || !contactEmail) {
            return showToast(
              "Nome, tipo, segmento e email de contato são obrigatórios",
              "danger"
            );
          }

          if (!id) {
            const res = await fetch(`${API_URL}/admin/companies`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name,
                type,
                segment,
                contactEmail,
                site: site || null,
                usefulLinks: usefulLinks,
              }),
            });
            const data = await res.json();
            if (!res.ok) {
              throw new Error(
                data.message || data.error || "Erro ao criar empresa"
              );
            }
            showToast("Empresa criada", "success");
            idEl.value = data.id;
            loadCompaniesAdmin();
            return;
          }

          const res = await fetch(`${API_URL}/admin/companies/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              type,
              active,
              segment,
              contactEmail,
              site: site || "",
              usefulLinks: usefulLinks,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(
              data.message || data.error || "Erro ao atualizar empresa"
            );
          }

          showToast("Empresa atualizada", "success");
          loadCompaniesAdmin();
        } catch (e) {
          showToast(e.message, "danger");
        }
      }

      applyRoleVisibility();

      function logout() {
        try {
          localStorage.removeItem("authToken");
          localStorage.removeItem("userRole");
          localStorage.removeItem("userName");
          localStorage.removeItem("userEmail");
          localStorage.removeItem("userCompanyId");
        } finally {
          window.location.href = "/login.html";
        }
      }
    </script>
  </body>
</html>
