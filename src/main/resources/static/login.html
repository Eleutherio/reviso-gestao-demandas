<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviso | Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f7fb;
        overflow-x: hidden;
      }

      .card-shadow {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid #eef1f5;
      }

      .cta-button {
        padding: 2rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        width: 100%;
        text-align: center;
        margin-bottom: 1rem;
      }

      .cta-agencia {
        background: #212529;
        color: white;
      }

      .cta-agencia:hover {
        background: #343a40;
        color: white;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .cta-empresa {
        background: white;
        color: #212529;
        border: 2px solid #212529;
      }

      .cta-empresa:hover {
        background: #f8f9fa;
        color: #212529;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 100vw;
        pointer-events: none;
      }

      #toastContainer .toast {
        pointer-events: auto;
        margin-bottom: 10px;
        min-width: 250px;
        max-width: calc(100vw - 40px);
      }

      @media (max-width: 992px) {
        #toastContainer {
          top: 10px;
          right: 10px;
        }
        #toastContainer .toast {
          min-width: 200px;
          max-width: calc(100vw - 20px);
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Selection Screen -->
    <div id="selectionScreen">
      <nav class="navbar navbar-dark bg-dark mb-3">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1">Reviso</span>
        </div>
      </nav>

      <div class="container mt-5">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div class="card card-shadow">
              <div class="card-body p-5">
                <h3 class="mb-4 text-center">Como deseja acessar?</h3>
                <button
                  class="cta-button cta-agencia"
                  onclick="showLoginModal('AGENCY')"
                >
                  üì± Sou Ag√™ncia
                </button>
                <button
                  class="cta-button cta-empresa"
                  onclick="showLoginModal('CLIENT')"
                >
                  üè¢ Sou Empresa
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- App Screen (after login) -->
    <div id="appScreen" style="display: none">
      <nav class="navbar navbar-dark bg-dark mb-3">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1"
            >Reviso - <span id="portalTitle">Portal</span></span
          >
          <div class="d-flex gap-2">
            <span class="navbar-text text-light me-3">
              <small id="userInfo">Usu√°rio</small>
            </span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
              Sair
            </button>
          </div>
        </div>
      </nav>

      <div class="container-fluid">
        <ul
          class="nav nav-pills mb-3"
          id="mainTabs"
          role="tablist"
          style="display: none"
        >
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="tab-briefings"
              data-bs-toggle="pill"
              data-bs-target="#pane-briefings"
              type="button"
              role="tab"
            >
              Inbox de Briefings
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="tab-requests"
              data-bs-toggle="pill"
              data-bs-target="#pane-requests"
              type="button"
              role="tab"
            >
              Gerenciar Requisi√ß√µes
            </button>
          </li>
        </ul>

        <div class="tab-content" id="tabContent">
          <!-- Briefings Tab -->
          <div
            class="tab-pane fade show active"
            id="pane-briefings"
            role="tabpanel"
          >
            <div class="row g-3">
              <div class="col-lg-4">
                <div class="card card-shadow">
                  <div class="card-body">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5 class="card-title mb-0">Briefings Pendentes</h5>
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        onclick="loadBriefings()"
                      >
                        ‚Üª
                      </button>
                    </div>
                    <div
                      class="list-scroll"
                      id="briefingsList"
                      style="max-height: calc(100vh - 280px); overflow-y: auto"
                    ></div>
                  </div>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="card card-shadow" id="briefingDetailCard">
                  <div class="card-body">
                    <div
                      id="briefingDetail"
                      class="text-muted text-center py-5"
                    >
                      Selecione um briefing para visualizar
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Requests Tab -->
          <div class="tab-pane fade" id="pane-requests" role="tabpanel">
            <div class="row g-3">
              <div class="col-lg-4">
                <div class="card card-shadow">
                  <div class="card-body">
                    <div
                      class="d-flex justify-content-between align-items-center mb-3"
                    >
                      <h5 class="card-title mb-0">Requisi√ß√µes</h5>
                      <button
                        class="btn btn-outline-secondary btn-sm"
                        onclick="loadRequests()"
                      >
                        ‚Üª
                      </button>
                    </div>
                    <div
                      class="mb-3"
                      style="max-height: calc(100vh - 280px); overflow-y: auto"
                      id="requestsList"
                    ></div>
                  </div>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="card card-shadow">
                  <div class="card-body">
                    <div id="requestDetail" class="text-muted text-center py-5">
                      Selecione uma requisi√ß√£o para visualizar
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Login Modal -->
    <div
      class="modal"
      id="loginModal"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-shadow">
          <div class="modal-header border-bottom">
            <h5 class="modal-title" id="modalTitle">Login - Ag√™ncia</h5>
            <button
              type="button"
              class="btn-close"
              onclick="closeLoginModal()"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="loginEmail"
                placeholder="seu.email@empresa.com"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Senha</label>
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>
          </div>
          <div class="modal-footer border-top">
            <button
              type="button"
              class="btn btn-outline-secondary"
              onclick="closeLoginModal()"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-dark" onclick="performLogin()">
              Entrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "http://localhost:8080";
      let authToken = null;
      let currentUser = null;
      let currentUserType = null;
      let selectedBriefing = null;
      let selectedRequest = null;

      function showToast(message, type = "info") {
        const toastContainer = document.getElementById("toastContainer");
        const toastId = "toast-" + Date.now();
        const bgClass =
          type === "success"
            ? "bg-success"
            : type === "error"
            ? "bg-danger"
            : "bg-info";

        const toastHtml = `
          <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
            <div class="toast-body">${message}</div>
          </div>`;

        toastContainer.insertAdjacentHTML("beforeend", toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        toastElement.addEventListener("hidden.bs.toast", () =>
          toastElement.remove()
        );
      }

      function showLoginModal(type) {
        currentUserType = type;
        const title = type === "AGENCY" ? "Login - Ag√™ncia" : "Login - Empresa";
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("loginEmail").value = "";
        document.getElementById("loginPassword").value = "";

        if (type === "AGENCY") {
          document.getElementById("loginEmail").value = "joao@reviso.com";
          document.getElementById("loginPassword").value = "designer123";
        } else {
          document.getElementById("loginEmail").value = "maria@clienteabc.com";
          document.getElementById("loginPassword").value = "cliente123";
        }

        const modal = new bootstrap.Modal(
          document.getElementById("loginModal")
        );
        modal.show();
      }

      function closeLoginModal() {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("loginModal")
        );
        if (modal) modal.hide();
        currentUserType = null;
      }

      async function performLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          showToast("Preencha email e senha", "error");
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          if (!response.ok) {
            const error = await response.json();
            showToast(error.error || "Erro ao fazer login", "error");
            return;
          }

          const data = await response.json();

          const isAgency =
            data.role === "AGENCY_ADMIN" || data.role === "AGENCY_USER";
          const isClient = data.role === "CLIENT_USER";

          if (currentUserType === "AGENCY" && !isAgency) {
            showToast("Acesso negado. Usu√°rio n√£o √© da ag√™ncia.", "error");
            return;
          }

          if (currentUserType === "CLIENT" && !isClient) {
            showToast("Acesso negado. Usu√°rio n√£o √© cliente.", "error");
            return;
          }

          authToken = data.token;
          currentUser = data;

          // Persiste contexto m√≠nimo e redireciona para index.html, onde as abas s√£o controladas por role
          localStorage.setItem("authToken", data.token);
          localStorage.setItem("userRole", data.role);
          localStorage.setItem("userName", data.fullName || "");
          localStorage.setItem("userEmail", data.email || "");
          localStorage.setItem("userCompanyId", data.companyId || "");

          closeLoginModal();
          showToast(`Bem-vindo, ${data.fullName}!`, "success");
          setTimeout(() => {
            window.location.href = "/index.html";
          }, 300);
        } catch (error) {
          showToast("Erro ao conectar ao servidor", "error");
        }
      }

      async function fetchWithAuth(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          ...options.headers,
        };
        if (authToken) {
          headers.Authorization = `Bearer ${authToken}`;
        }

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) {
          showToast("Sess√£o expirada. Fa√ßa login novamente.", "error");
          logout();
          throw new Error("Unauthorized");
        }

        return response;
      }

      function logout() {
        authToken = null;
        currentUser = null;
        currentUserType = null;
        selectedBriefing = null;
        selectedRequest = null;
        document.getElementById("selectionScreen").style.display = "block";
        document.getElementById("appScreen").style.display = "none";
      }

      async function loadBriefings() {
        try {
          const response = await fetchWithAuth(
            `${API_URL}/agency/briefings?status=PENDING`
          );
          const briefings = await response.json();

          const html = briefings.length
            ? briefings
                .map(
                  (b) => `
              <div class="card mb-2" style="cursor: pointer;" onclick="selectBriefing('${b.id}')">
                <div class="card-body p-3">
                  <h6 class="mb-1">${b.title}</h6>
                  <p class="text-muted small mb-0">${b.clientName}</p>
                </div>
              </div>`
                )
                .join("")
            : "<p class='text-muted'>Nenhum briefing pendente</p>";

          document.getElementById("briefingsList").innerHTML = html;

          if (briefings.length > 0 && !selectedBriefing) {
            selectBriefing(briefings[0].id);
          }
        } catch (error) {
          showToast("Erro ao carregar briefings", "error");
        }
      }

      async function selectBriefing(id) {
        try {
          const response = await fetchWithAuth(`${API_URL}/briefings/${id}`);
          selectedBriefing = await response.json();

          const html = `
            <h5>${selectedBriefing.title}</h5>
            <p class="text-muted">Cliente: ${selectedBriefing.clientName}</p>
            <hr />
            <p><strong>Descri√ß√£o:</strong></p>
            <p>${selectedBriefing.description || "Sem descri√ß√£o"}</p>
            <hr />
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-success" onclick="convertToRequest()">
                ‚úî Converter em Requisi√ß√£o
              </button>
              <button class="btn btn-danger" onclick="showRejectModal()">
                ‚úñ Rejeitar
              </button>
            </div>
            <div id="rejectForm" style="display: none" class="mt-3">
              <label class="form-label">Motivo da rejei√ß√£o:</label>
              <textarea class="form-control mb-2" id="rejectReason" rows="3"></textarea>
              <button class="btn btn-danger btn-sm" onclick="rejectBriefing()">Confirmar rejei√ß√£o</button>
              <button class="btn btn-outline-secondary btn-sm" onclick="hideRejectModal()">Cancelar</button>
            </div>
          `;

          document.getElementById("briefingDetail").innerHTML = html;
        } catch (error) {
          showToast("Erro ao carregar detalhes do briefing", "error");
        }
      }

      function showRejectModal() {
        document.getElementById("rejectForm").style.display = "block";
      }

      function hideRejectModal() {
        document.getElementById("rejectForm").style.display = "none";
        document.getElementById("rejectReason").value = "";
      }

      async function convertToRequest() {
        if (!selectedBriefing) return;

        try {
          const response = await fetchWithAuth(
            `${API_URL}/agency/briefings/${selectedBriefing.id}/convert`,
            { method: "POST" }
          );

          if (!response.ok) {
            const error = await response.json();
            showToast(error.error || "Erro ao converter", "error");
            return;
          }

          showToast("Briefing convertido em requisi√ß√£o!", "success");
          loadBriefings();
        } catch (error) {
          showToast("Erro ao converter briefing", "error");
        }
      }

      async function rejectBriefing() {
        if (!selectedBriefing) return;

        const reason = document.getElementById("rejectReason").value.trim();
        if (!reason) {
          showToast("Informe o motivo da rejei√ß√£o", "error");
          return;
        }

        try {
          const response = await fetchWithAuth(
            `${API_URL}/agency/briefings/${selectedBriefing.id}/reject`,
            {
              method: "POST",
              body: JSON.stringify({ reason }),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            showToast(error.error || "Erro ao rejeitar", "error");
            return;
          }

          showToast("Briefing rejeitado com sucesso", "success");
          hideRejectModal();
          loadBriefings();
        } catch (error) {
          showToast("Erro ao rejeitar briefing", "error");
        }
      }

      async function loadRequests() {
        try {
          const response = await fetchWithAuth(`${API_URL}/requests`);
          const requests = await response.json();

          const html = requests.length
            ? requests
                .map(
                  (r) => `
              <div class="card mb-2" style="cursor: pointer;" onclick="selectRequest('${r.id}')">
                <div class="card-body p-3">
                  <h6 class="mb-1">${r.title}</h6>
                  <small class="text-muted">${r.clientName}</small>
                </div>
              </div>`
                )
                .join("")
            : "<p class='text-muted'>Nenhuma requisi√ß√£o</p>";

          document.getElementById("requestsList").innerHTML = html;

          if (requests.length > 0 && !selectedRequest) {
            selectRequest(requests[0].id);
          }
        } catch (error) {
          showToast("Erro ao carregar requisi√ß√µes", "error");
        }
      }

      async function loadMyRequests() {
        try {
          const response = await fetchWithAuth(`${API_URL}/requests/mine`);
          const requests = await response.json();

          const html = requests.length
            ? requests
                .map(
                  (r) => `
              <div class="card mb-2" style="cursor: pointer;" onclick="selectRequest('${
                r.id
              }')">
                <div class="card-body p-3">
                  <h6 class="mb-1">${r.title}</h6>
                  <small class="text-muted">${new Date(
                    r.createdAt
                  ).toLocaleDateString("pt-BR")}</small>
                </div>
              </div>`
                )
                .join("")
            : "<p class='text-muted'>Nenhuma requisi√ß√£o</p>";

          document.getElementById("requestsList").innerHTML = html;

          if (requests.length > 0 && !selectedRequest) {
            selectRequest(requests[0].id);
          }
        } catch (error) {
          showToast("Erro ao carregar requisi√ß√µes", "error");
        }
      }

      async function selectRequest(id) {
        try {
          const response = await fetchWithAuth(`${API_URL}/requests/${id}`);
          const request = await response.json();
          selectedRequest = request;

          const html = `
            <h5>${request.title}</h5>
            <p class="text-muted">Cliente: ${request.clientName}</p>
            <hr />
            <p><strong>Descri√ß√£o:</strong></p>
            <p>${request.description || "Sem descri√ß√£o"}</p>
            <hr />
            <h6>Hist√≥rico:</h6>
            <div id="eventsList" class="mt-2"></div>
          `;

          document.getElementById("requestDetail").innerHTML = html;
          loadRequestEvents(id);
        } catch (error) {
          showToast("Erro ao carregar detalhes", "error");
        }
      }

      async function loadRequestEvents(requestId) {
        try {
          const response = await fetchWithAuth(
            `${API_URL}/requests/${requestId}/events`
          );
          const events = await response.json();

          const html = events.length
            ? events
                .map(
                  (e) => `
              <div class="card mb-2">
                <div class="card-body p-2">
                  <small><strong>${e.eventType}</strong> - ${new Date(
                    e.timestamp
                  ).toLocaleString("pt-BR")}</small>
                </div>
              </div>`
                )
                .join("")
            : "<p class='text-muted small'>Nenhum evento</p>";

          document.getElementById("eventsList").innerHTML = html;
        } catch (error) {
          console.error("Erro ao carregar eventos:", error);
        }
      }

      document.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          const modal = document.getElementById("loginModal");
          if (modal && modal.classList.contains("show")) {
            performLogin();
          }
        }
      });
    </script>
  </body>
</html>
