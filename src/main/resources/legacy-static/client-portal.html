<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reviso | Portal do Cliente</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f6f7fb;
        overflow-x: hidden;
      }

      .card-shadow {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid #eef1f5;
      }

      .clickable {
        cursor: pointer;
      }

      .list-scroll {
        max-height: calc(100vh - 320px);
        overflow-y: auto;
      }

      #toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 2000;
        max-width: 100vw;
        pointer-events: none;
      }

      #toastContainer .toast {
        pointer-events: auto;
        margin-bottom: 10px;
        min-width: 250px;
        max-width: calc(100vw - 40px);
      }

      @media (max-width: 992px) {
        .list-scroll {
          max-height: 45vh;
        }
        #toastContainer {
          top: 10px;
          right: 10px;
        }
        #toastContainer .toast {
          min-width: 200px;
          max-width: calc(100vw - 20px);
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark mb-3">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Reviso - Portal do Cliente</span>
        <div class="d-flex gap-2 align-items-center">
          <span class="navbar-text text-light me-2">
            <small id="userInfo">Deslogado</small>
          </span>
          <button
            id="logoutButton"
            class="btn btn-outline-light btn-sm"
            onclick="logout()"
            style="display: none"
          >
            Sair
          </button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div id="loginView" class="row justify-content-center">
        <div class="col-md-6">
          <div class="card card-shadow">
            <div class="card-body p-4">
              <h4 class="mb-3">Login</h4>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  placeholder="maria@clienteabc.com"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Senha</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  placeholder="cliente123"
                />
              </div>
              <button class="btn btn-dark w-100" onclick="performLogin()">
                Entrar
              </button>
              <div class="text-muted small mt-3">
                Dica: use o usuário de cliente demo se estiver com o banco
                seedado.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="portalView" style="display: none">
        <div class="row g-3">
          <div class="col-lg-5">
            <div class="card card-shadow mb-3">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h5 class="card-title mb-0">Enviar Briefing</h5>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="loadMine()"
                  >
                    Atualizar
                  </button>
                </div>

                <div class="mb-2">
                  <label class="form-label">Título *</label>
                  <input
                    class="form-control"
                    id="briefingTitle"
                    placeholder="Ex: Campanha de lançamento"
                  />
                </div>
                <div class="mb-2">
                  <label class="form-label">Descrição</label>
                  <textarea
                    class="form-control"
                    id="briefingDescription"
                    rows="3"
                    placeholder="Contexto, links e referências"
                  ></textarea>
                </div>

                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="briefingType">
                      <option value="">Selecione...</option>
                      <option value="POST">Post</option>
                      <option value="STORY">Story</option>
                      <option value="BANNER">Banner</option>
                      <option value="LANDING_PAGE">Landing page</option>
                      <option value="TRAFFIC">Tráfego</option>
                      <option value="EMAIL">E-mail</option>
                      <option value="VIDEO">Vídeo</option>
                      <option value="OTHER">Outro</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Prioridade</label>
                    <select class="form-select" id="briefingPriority">
                      <option value="">Selecione...</option>
                      <option value="LOW">Baixa</option>
                      <option value="MEDIUM">Média</option>
                      <option value="HIGH">Alta</option>
                      <option value="URGENT">Urgente</option>
                    </select>
                  </div>
                </div>

                <div class="mt-2">
                  <label class="form-label">Vencimento</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="briefingDueDate"
                  />
                  <div class="form-text">
                    Observação: estes campos extras são anexados à descrição do
                    briefing.
                  </div>
                </div>

                <button
                  class="btn btn-success w-100 mt-3"
                  onclick="createBriefing()"
                >
                  Enviar briefing
                </button>
              </div>
            </div>

            <div class="card card-shadow">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h5 class="card-title mb-0">Meus Briefings</h5>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="loadMyBriefings()"
                  >
                    Atualizar
                  </button>
                </div>
                <div id="myBriefings" class="list-scroll"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card card-shadow mb-3">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h5 class="card-title mb-0">Minhas Requisições</h5>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="loadMyRequests()"
                  >
                    Atualizar
                  </button>
                </div>
                <div id="myRequests" class="list-scroll"></div>
              </div>
            </div>

            <div
              class="card card-shadow"
              id="requestDetailCard"
              style="display: none"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h5 class="card-title mb-0" id="reqTitle">Detalhe</h5>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="loadSelectedEvents()"
                  >
                    Atualizar eventos
                  </button>
                </div>

                <div class="mb-2 text-muted small" id="reqMeta"></div>
                <div class="mb-3" id="reqBadges"></div>
                <div class="mb-3">
                  <strong>Descrição</strong>
                  <div class="text-muted" id="reqDesc">-</div>
                </div>

                <h6 class="mt-3">Eventos visíveis</h6>
                <div id="reqEvents" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "http://localhost:8080";
      const TOKEN_KEY = "reviso_token";
      const USER_KEY = "reviso_user";

      let authToken = null;
      let currentUser = null;
      let selectedRequest = null;

      function showToast(message, type = "success") {
        const toastEl = document.createElement("div");
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.setAttribute("role", "alert");
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.getElementById("toastContainer").appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 2800 });
        toast.show();
        toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
      }

      function statusBadge(status) {
        const map = {
          NEW: "secondary",
          IN_PROGRESS: "warning",
          IN_REVIEW: "info",
          CHANGES_REQUESTED: "danger",
          APPROVED: "success",
          DELIVERED: "primary",
          CLOSED: "dark",
        };
        const color = map[status] || "secondary";
        return `<span class="badge text-bg-${color}">${status}</span>`;
      }

      function priorityBadge(priority) {
        const map = {
          LOW: "secondary",
          MEDIUM: "info",
          HIGH: "warning",
          URGENT: "danger",
        };
        const color = map[priority] || "secondary";
        return `<span class="badge text-bg-${color}">${priority}</span>`;
      }

      function setAuth(token, user) {
        authToken = token;
        currentUser = user;
        if (token) localStorage.setItem(TOKEN_KEY, token);
        if (user) localStorage.setItem(USER_KEY, JSON.stringify(user));
      }

      function clearAuth() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(USER_KEY);
      }

      function showLogin() {
        document.getElementById("loginView").style.display = "flex";
        document.getElementById("portalView").style.display = "none";
        document.getElementById("logoutButton").style.display = "none";
        document.getElementById("userInfo").textContent = "Deslogado";
        selectedRequest = null;
      }

      function showPortal() {
        document.getElementById("loginView").style.display = "none";
        document.getElementById("portalView").style.display = "block";
        document.getElementById("logoutButton").style.display = "inline-block";

        const label = currentUser
          ? `${currentUser.fullName || "Logado"} (${currentUser.email || ""})` +
            (currentUser.companyId ? ` · ${currentUser.companyId}` : "")
          : "Logado";

        document.getElementById("userInfo").textContent = label;
      }

      async function apiFetch(path, options = {}) {
        const headers = {
          ...options.headers,
        };

        if (options.body && !headers["Content-Type"]) {
          headers["Content-Type"] = "application/json";
        }

        if (authToken) {
          headers.Authorization = `Bearer ${authToken}`;
        }

        const res = await fetch(`${API_URL}${path}`, { ...options, headers });

        if (res.status === 401) {
          clearAuth();
          showLogin();
          showToast("Sessão expirada. Faça login novamente.", "danger");
          throw new Error("Unauthorized");
        }

        const contentType = res.headers.get("content-type") || "";
        const data = contentType.includes("application/json")
          ? await res.json()
          : await res.text();

        if (!res.ok) {
          const message =
            (data && (data.message || data.error)) || `Erro HTTP ${res.status}`;

          const err = new Error(message);
          err.status = res.status;
          err.data = data;
          throw err;
        }

        return data;
      }

      async function performLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        if (!email || !password) {
          showToast("Preencha email e senha", "danger");
          return;
        }

        try {
          const data = await apiFetch("/auth/login", {
            method: "POST",
            body: JSON.stringify({ email, password }),
          });

          if (data.role !== "CLIENT_USER") {
            showToast("Acesso negado. Use um usuário CLIENTE.", "danger");
            return;
          }

          setAuth(data.token, {
            userId: data.userId,
            fullName: data.fullName,
            email: data.email,
            role: data.role,
            companyId: data.companyId,
          });

          showToast("Login realizado", "success");
          showPortal();
          await loadMine();
        } catch (e) {
          const msg = e?.data?.message || e?.message || "Erro ao fazer login";
          showToast(msg, "danger");
        }
      }

      function logout() {
        clearAuth();
        showLogin();
      }

      function buildBriefingDescription(
        description,
        type,
        priority,
        dueDateISO
      ) {
        const meta = [];
        if (type) meta.push(`Tipo: ${type}`);
        if (priority) meta.push(`Prioridade: ${priority}`);
        if (dueDateISO) meta.push(`Vencimento: ${dueDateISO}`);
        if (meta.length === 0) return description || undefined;

        const base = (description || "").trim();
        const suffix = `---\n${meta.join("\n")}`;
        return base ? `${base}\n\n${suffix}` : suffix;
      }

      function parseBriefingMeta(description) {
        const result = { type: null, priority: null, dueDate: null };
        if (!description) return result;

        const marker = "---\n";
        const idx = description.lastIndexOf(marker);
        if (idx < 0) return result;

        const metaBlock = description.substring(idx + marker.length);
        metaBlock.split("\n").forEach((line) => {
          const trimmed = (line || "").trim();
          if (trimmed.startsWith("Tipo:"))
            result.type = trimmed.replace("Tipo:", "").trim();
          if (trimmed.startsWith("Prioridade:"))
            result.priority = trimmed.replace("Prioridade:", "").trim();
          if (trimmed.startsWith("Vencimento:"))
            result.dueDate = trimmed.replace("Vencimento:", "").trim();
        });

        return result;
      }

      async function createBriefing() {
        const title = document.getElementById("briefingTitle").value.trim();
        if (!title) {
          showToast("Título é obrigatório", "danger");
          return;
        }

        const description = document
          .getElementById("briefingDescription")
          .value.trim();
        const type = document.getElementById("briefingType").value || null;
        const priority =
          document.getElementById("briefingPriority").value || null;

        const due = document.getElementById("briefingDueDate").value;
        const dueDateISO = due ? new Date(due).toISOString() : null;

        const payload = {
          title,
          description: buildBriefingDescription(
            description,
            type,
            priority,
            dueDateISO
          ),
        };

        try {
          await apiFetch("/briefings", {
            method: "POST",
            body: JSON.stringify(payload),
          });

          showToast("Briefing enviado", "success");
          document.getElementById("briefingTitle").value = "";
          document.getElementById("briefingDescription").value = "";
          document.getElementById("briefingType").value = "";
          document.getElementById("briefingPriority").value = "";
          document.getElementById("briefingDueDate").value = "";

          await loadMyBriefings();
        } catch (e) {
          const data = e?.data;
          const errors = data?.errors;
          if (errors && typeof errors === "object") {
            const first = Object.values(errors)[0];
            showToast(first || "Dados inválidos", "danger");
            return;
          }
          showToast(e?.message || "Erro ao enviar briefing", "danger");
        }
      }

      function renderMyBriefings(briefings) {
        const el = document.getElementById("myBriefings");
        if (!briefings || briefings.length === 0) {
          el.innerHTML =
            '<div class="alert alert-secondary">Nenhum briefing</div>';
          return;
        }

        el.innerHTML = briefings
          .map((b) => {
            const created = b.createdAt
              ? new Date(b.createdAt).toLocaleString("pt-BR")
              : "-";
            const meta = parseBriefingMeta(b.description);
            const due = meta.dueDate
              ? new Date(meta.dueDate).toLocaleString("pt-BR")
              : "-";

            const type = meta.type || "-";
            const priority = meta.priority || "-";

            return `
              <div class="card mb-2">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-semibold">${b.title}</div>
                      <div class="text-muted small">Status: ${b.status} · Criado: ${created}</div>
                      <div class="text-muted small">Tipo: ${type} · Prioridade: ${priority}</div>
                      <div class="text-muted small">Vencimento: ${due}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function loadMyBriefings() {
        try {
          const data = await apiFetch("/briefings/mine");
          renderMyBriefings(data);
        } catch (e) {
          showToast(e?.message || "Erro ao carregar briefings", "danger");
        }
      }

      function renderMyRequests(requests) {
        const el = document.getElementById("myRequests");
        if (!requests || requests.length === 0) {
          el.innerHTML =
            '<div class="alert alert-secondary">Nenhuma requisição</div>';
          return;
        }

        el.innerHTML = requests
          .map((r) => {
            const due = r.dueDate
              ? new Date(r.dueDate).toLocaleString("pt-BR")
              : "Não definido";
            const updated = r.updatedAt
              ? new Date(r.updatedAt).toLocaleString("pt-BR")
              : "-";
            return `
              <div class="list-group-item list-group-item-action clickable" onclick="selectRequest('${
                r.id
              }')">
                <div class="d-flex justify-content-between">
                  <div class="me-2">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <strong>${r.title}</strong>
                      ${statusBadge(r.status)}
                      ${priorityBadge(r.priority)}
                      <span class="badge text-bg-light">${r.department}</span>
                    </div>
                    <div class="text-muted small">Vencimento: ${due} · Atualizado: ${updated}</div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function loadMyRequests() {
        try {
          const data = await apiFetch("/requests/mine");
          renderMyRequests(data);
        } catch (e) {
          showToast(e?.message || "Erro ao carregar requisições", "danger");
        }
      }

      async function selectRequest(id) {
        try {
          const requests = await apiFetch("/requests/mine");
          const req = (requests || []).find((r) => r.id === id);
          if (!req) {
            showToast("Requisição não encontrada", "danger");
            return;
          }
          selectedRequest = req;
          renderRequestDetail(req);
          await loadSelectedEvents();
        } catch (e) {
          showToast(e?.message || "Erro ao selecionar requisição", "danger");
        }
      }

      function renderRequestDetail(req) {
        document.getElementById("requestDetailCard").style.display = "block";
        document.getElementById("reqTitle").textContent = req.title;

        const due = req.dueDate
          ? new Date(req.dueDate).toLocaleString("pt-BR")
          : "Não definido";
        const updated = req.updatedAt
          ? new Date(req.updatedAt).toLocaleString("pt-BR")
          : "-";

        document.getElementById(
          "reqMeta"
        ).textContent = `ID: ${req.id} · Vencimento: ${due} · Atualizado: ${updated}`;

        document.getElementById("reqBadges").innerHTML = `${statusBadge(
          req.status
        )} ${priorityBadge(req.priority)} <span class="badge text-bg-light">${
          req.department
        }</span> <span class="badge text-bg-light">${req.type}</span>`;

        document.getElementById("reqDesc").textContent =
          req.description || "Sem descrição";
      }

      function renderEvents(events) {
        const el = document.getElementById("reqEvents");
        if (!events || events.length === 0) {
          el.innerHTML =
            '<div class="alert alert-secondary">Nenhum evento visível</div>';
          return;
        }

        const sorted = [...events].sort((a, b) =>
          (a.createdAt || "").localeCompare(b.createdAt || "")
        );

        el.innerHTML = sorted
          .map((ev) => {
            const created = ev.createdAt
              ? new Date(ev.createdAt).toLocaleString("pt-BR")
              : "-";
            const msg = ev.message || "";
            return `
              <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold">${ev.eventType}</div>
                  <div class="text-muted small">${created}</div>
                </div>
                <div class="text-muted">${msg}</div>
              </div>
            `;
          })
          .join("");
      }

      async function loadSelectedEvents() {
        if (!selectedRequest) return;
        try {
          const data = await apiFetch(
            `/requests/${selectedRequest.id}/events?onlyVisibleToClient=true`
          );
          renderEvents(data);
        } catch (e) {
          showToast(e?.message || "Erro ao carregar eventos", "danger");
        }
      }

      async function loadMine() {
        await Promise.all([loadMyBriefings(), loadMyRequests()]);
      }

      function restoreSession() {
        const token = localStorage.getItem(TOKEN_KEY);
        const userRaw = localStorage.getItem(USER_KEY);
        if (!token) {
          showLogin();
          return;
        }

        authToken = token;
        try {
          currentUser = userRaw ? JSON.parse(userRaw) : null;
        } catch {
          currentUser = null;
        }

        showPortal();
        loadMine();
      }

      restoreSession();
    </script>
  </body>
</html>
